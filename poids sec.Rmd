---
title: Data regression 
output: 
  html_document:
    toc: yes
    toc_float: yes
editor_options: 
  chunk_output_type: inline
---
```{r package, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(eval = T, cache = T, message = F, warning=F)
library(ggplot2)
library(ggpubr)
library(reshape2)
library(dplyr)
library(plotly)

```
```{r biniou cleaning}
#Clean the biniou

rm(list = ls()) ; invisible(gc());graphics.off()
```


```{r choose file, eval=FALSE}
#choose.files()
```

```{r data upload}
DW <- read.csv("C:\\Users\\emduc\\Desktop\\Drive\\symphostage\\PoidsSecSympho.csv",header = T, dec = ",", sep=";") 
Ecorce<- read.csv("C:\\Users\\emduc\\Desktop\\Drive\\symphostage\\Measures - Individuals2.csv", header = T, dec=",", sep=";")
LTh <- read.csv("C:\\Users\\emduc\\Desktop\\Drive\\symphostage\\Measures - Fresh.csv", header = T, dec=".", sep=";")
LA <- read.csv("C:\\Users\\emduc\\Desktop\\Drive\\symphostage\\Results Total Threshold- corrigé.csv", header = T, dec=".", sep=";")
densite <- read.csv("C:\\Users\\emduc\\Desktop\\Drive\\symphostage\\densite sympho.csv",header = T, dec = ",", sep=";")
SPAD <- read.csv("C:\\Users\\emduc\\Desktop\\Drive\\symphostage\\Measures - SPAD.csv",header = T, dec = ".", sep=",")
paracou <- read.csv("C:\\Users\\emduc\\Desktop\\Drive\\symphostage\\Symphonia_Paracou.csv",header = T, dec = ",", sep=";")
```



# Leaf dry weight
```{r data dry weight}
dw2 <- DW %>% 
  select(Parcelle, Carr., Num.ro, F1,F2,F3,F4,F5) %>% 
  mutate(MeanDW = (F1+F2+F3+F4+F5) / 5 )%>%
  mutate(Index= paste(Parcelle, Carr., Num.ro, sep="_"))

 # dw2 %>% filter(MeanDW %>% is.na == T)
 
  
```

# Bark categories
```{r data bark field}
bark<-Ecorce %>% 
  select(Parcelle,Carre, Numero, ecorce) %>% 
  mutate(Index= paste(Parcelle,Carre,Numero, sep="_"))
```

?merge

```{r}
#dat <- merge(dw2, bark) 
# as.tbl(dat)
```

```{r}
#dat %>%
  #select(MeanDW, ecorce) %>% 
  #filter(ecorce !="") %>% 
  #ggplot(aes(x=ecorce, y= MeanDW, fill= ecorce))+
  #geom_boxplot()
```


# LMDC & Leaf thickness
```{r data Lth and LMDC, include=FALSE}

LTh %>%  
  select(Parcelle, Carr?., Num?.ro, Poids.frais, Feuille) %>% 
  mutate(Index= paste(Parcelle,Carr?. , Num?.ro, Feuille, sep="_"))
dw2 %>% as.tbl

LTh %<>% rename(Carre = Carr?.) %>%  rename(Numero = Num?.ro)
LTh %<>% mutate(Index = paste(Parcelle,Carre,Numero, sep = "_"))
                
                
final  <- dw2 %>%
  rename("1" = F1) %>% 
  rename("2" = F2) %>% 
  rename("3" = F3) %>%
  rename("4" = F4) %>% 
  rename("5" = F5) %>% 
  select(Index, "1","2","3","4","5") %>% 
  reshape::melt(id.var = "Index", variable.name = leaf) %>%
  rename(Feuille=variable) %>% 
  rename(Psec = value) %>% 
  mutate(Feuille = as.integer(Feuille))%>%
  as.tbl%>%
  merge(LTh) %>% 
  as.tbl %>%  
  mutate(LMDC = (Psec/Poids.frais))

final %<>% mutate( meanLth= (LT.1+LT.2+LT.3)/3)


# final %<>% rename(Pfrais = Poids.frais)
# final%<>%select(-X)
#final <- final[which(!is.na(final$Psec)),]
 

#class(LTh$Feuille)


```

# Leaf area 
## table transformation 

```{r data LA, include=FALSE}

#LA %<>% rename(Carre = Carré) %>% rename(Numero = Numéro)
LA %<>% mutate(Index = paste(Parcelle,Carre,Numero, sep = "_"))
LA %>% mutate(Feuille = NA) 
LA$Feuille[1] = 5
count = 5
for (i in 2:length(LA$Index)) 
{
  
  if(LA$Index[i-1] == LA$Index[i]) {count = count-1}
  else {count <- 5}
    LA$Feuille[i]<-count
}
LA %>% as.tbl() 

```

m?me nombre d'observation dans les deux dataframe 


```{r reduction data LA and final, include=FALSE}
LA %<>% 
  mutate(ID = paste(Index, Feuille,sep="_"))

final %<>%
  mutate(ID = paste(Index, Feuille, sep="_"))

final %<>% 
  select(Index, ID, Feuille, LMDC, Psec, Poids.frais, meanLth ) %>%
  filter(ID %in% LA$ID) %>% 
  as.data.frame()

LA %<>%
  select(Index, ID, Area, Feuille) %>% 
  filter(ID %in% final$ID) %>%  
  as.data.frame()

# final %>% select(Index) %>% filter(!Index %in% LA$Index) %>% as.data.frame() to check for ddiffs
```
## total data table 


```{r merge LA and final, include=FALSE}

total <- merge.data.frame(LA,final)
```


## SLA 

```{r column SLA, include=FALSE}

total %<>%  
  mutate ( SLA = (Area/Psec))  

 
```

# densite 
A revoir car uniquement 3 observation en commun ...
```{r densite bark and wood data, eval=FALSE, include=FALSE}
densite %<>%  
  mutate(Index = paste(Parcelle,Carr., Num.ro, sep="_"))  

paracou %<>%
  mutate(Index = paste(n_parcelle, n_carre, n_arbre, sep="_")) %>% 
  filter(Index %in% densite$Index) 
 # filter(campagne=="2015")


#dens <- densite %>% 
 # select(Index, IDEcorce, Idbois, bark.investment, bark.thickness) %>%
  #filter(Index %in% plaute$Index) %>% 
  #as.data.frame()


#test <- plaute %>% 
 # select(Index, ID, Feuille, LMDC, Psec, Poids.frais, meanLth ) %>%
  #filter(Index %in% densite$Index) %>% 
  #as.data.frame()
```


# SPAD
```{r spad data}
SPAD %<>% 
  rename(Carre = "Carr?.") %>% 
  rename(Numero = "Num?.ro") %>% 
  mutate(Index = paste (Parcelle, Carre, Numero, sep ="_")) %>% 
  mutate(ID = paste (Parcelle, Carre, Numero, Feuille, sep ="_")) %>% 
  mutate(MeanSpad = ((SPAD.1+SPAD.2+SPAD.3)/3))
```
## selection complete value 

```{r reduction data spad}
Chloro <- SPAD %>%
  select(Index, ID, MeanSpad) %>% 
  filter(ID %in% total$ID) %>%  
  as.data.frame()

 final2 <-  merge(Chloro, total)
```



# PLOT

## Mean individuals values
```{r mean data in plaute, include=FALSE}

plaute <- final2 %>% 
  select(Index,LMDC,meanLth, SLA,Psec, Poids.frais, MeanSpad) %>%
  group_by(Index) %>% 
  summarize_all(mean)%>% 
  filter(LMDC <60) %>% 
  mutate(LMDC = LMDC*100)
  
 
  #merge(bark %>% 
  #select(ecorce,Index) %>%
  #filter(Index%in%final2$Index)) %>%
   #%>% 
  #as.tbl 

```

## Paracou individuals 

```{r paracou data, include=FALSE}

paracou2 <- paracou %>%
  mutate(Index = paste(n_parcelle, n_carre, n_arbre, sep="_")) %>% 
  filter(campagne == "2015") %>%
  select(Index,  circonf, espece) %>% 
  filter(Index %in% plaute$Index) 
  
plaute <- merge(plaute, paracou2)
  #
  
```



## hypervolume : SLA-Lth-LMDC plot

```{r, hypervolum}
plaute%>% plot_ly(x = ~LMDC, y=~SLA,z=~meanLth, color=~espece, colors= c("grey","violet","orange"),sizes = 0.01)
```
hypervolume with plotly but not really readable ... let's try with geom contour


### LMDC~SLA
```{r reg LMDC LA}

ggplot(plaute, aes(SLA, LMDC, color= espece, size = diameter))+
  geom_jitter(na.rm=T)+
  labs(title = "Regression LMDC in function of Specific Leaf Area with only 391 individuals", y="Leaf Dry Matter Content (LMDC) in g", x="Specific leaf area in g.cm?")
```

On voit qu'il y a une relation negative entre les deux variables mais faire une rda car reg implique un lien entre les deux variables alors qu'ici on parle de trait fonctionnel et ce n'est pas le cas 


```{r density2D LMDC SLA}
ggplot(plaute, aes(SLA, LMDC))+
  geom_density2d(na.rm=T, col = "orange")
```

Avec le density2D on voit qu'il y a un seul point de forte densit? ce qu'il veut dire que pour ces deux variable il n'y a qu'un seul optimum 


### LMDC~Lth

```{r reg LDM Lth}
ggplot(plaute, aes(meanLth, LMDC, color= espece))+
  geom_jitter(na.rm=T)+
  geom_smooth(method = lm, na.rm=T, aes(fill= espece))+
  stat_ellipse(na.rm=T)+
  labs(title = "Regression LMDC in function of Leaf thickness with only 391 individuals ", y=" Leaf Dry Matter Content (LMDC) in g", x="Leaf Thickness in mm")
```

Il y a quasiement pas de relation ni de diff?renciation entre les morphotypes 

```{r}
ggplot(plaute, aes(meanLth, LMDC))+
  geom_density2d(na.rm=T, col = "orange")
```

On voit ici aussi qu'il y a qu'un seul point a forte densit? il n'y a donc qu'un seul optimum pour cette combinaison de trait 
### Lth~SLA

```{r}
ggplot(plaute, aes(SLA, meanLth, color= espece, size = diameter))+
  geom_jitter(na.rm=T)+
  
  labs(title = "Regression Leaf thickness in function of SLA with only 391 individuals ", y="  Mean Leaf thickness for each individuals", x="Mean Specific leaf area (g.cm?)")

```
There is a strong negative relation between these two function trait that is not surprising and follow the same pattern as at the species and comminity scale. 

```{r}
ggplot(plaute, aes(SLA, meanLth))+
  geom_density2d(na.rm=T, col = "orange")
```
ONce again there is only one density center 

### SPAD 

```{r}
ggplot(plaute, aes(SLA, MeanSpad))+
  geom_density2d(na.rm=T, col = "orange")
```


## SLA distribution 

```{r}
  ggplot(plaute, aes(SLA ))+
  geom_histogram(na.rm= T, binwidth = 4)
```

## Leaf thickness distribution 

```{r}
ggplot(plaute, aes(meanLth))+
  geom_histogram(na.rm = T, binwidth = 12)
```

## LMDC distribution 

```{r}
ggplot(plaute, aes(LMDC))+
  geom_histogram(na.rm=T, binwidth = 1)
```





## SPAD distribution 

```{r}
ggplot(plaute, aes(MeanSpad))+
  geom_histogram(na.rm=T, binwidth = 1)
```


## densite distribution 
### Ecorce

```{r eval=FALSE, include=FALSE}
dens <- densite %>% 
  select(Ecorce,IDEcorce) %>% 
  filter(Ecorce != "") %>% 
ggplot(dens, aes(IDEcorce, fill= espece, alpha= 0.5))+
  geom_density()
```


### Bois

```{r}
dens <- densite %>% 
  select(Ecorce,Idbois) %>% 
  filter(Ecorce != "")
ggplot(dens, aes(Idbois, fill= Ecorce, alpha= 0.5))+
  geom_density()
```


## circonferance 
### transformation in diameter 

```{r}
plaute %<>% 
  mutate(diameter = (circonf/pi)) 
```

### plot 


?
```{r circonf Lth}
ggplot(plaute, aes(meanLth, diameter))+
  geom_point()
       
```


Leaf thickness seems to have a relation with the focal tree diameter so it migth depend of the ontogenic stage of the tree


```{r}
ggplot(plaute, aes(SLA, diameter))+
  geom_point()
```

Its seems that there is a negetic relationship between SLA and diameter so as diameter is a proxy of the ontogenetic stage. So younger tree have highter SLA value that it sounds normal because younger individuals would in leafwith hight acquisition potential to have a fast growing speed and reach the canopy area. 

```{r}
ggplot(plaute, aes(LMDC, diameter))+
  geom_point()
       
```

it seems that there is no relation between diameter and LMDC and also that some value are aberant

```{r}
ggplot(plaute, aes(MeanSpad, diameter))+
  geom_point(na.rm=T)
```



# SLA ~dawkins 

 index creation for dawkins measures

```{r dawkins index}
Dawkins <- Ecorce %>% 
  filter( Dawkins != "") %>% 
  mutate(Index = paste( Parcelle, Carre, Numero, sep = "_"))
```

combination with all mean traits table 

```{r}
 DawSLA <- 
  Dawkins %>% 
  select(Index, Dawkins, Bois) %>% 
  filter(Index %in% plaute$Index)


  lum <- merge(plaute,DawSLA) %>% 
    mutate( bois = (as.factor(Bois)))
  
```

```{r}
ggplot(lum , aes(x = SLA, y = diameter, color= Dawkins))+
  geom_point()
```

```{r}
lum %<>%  filter(LMDC < 60) %>% 
  
```



```{r}
ggplot(lum, aes(SLA, LMDC, color= Dawkins, size = diameter))+
  geom_jitter(na.rm=T)
```

```{r}
ggplot(lum, aes(x= Dawkins, y= as.factor(Bois), size = diameter))+
  geom_jitter()
```
So there is no link between branch sample and diameter. Broken branches does not come from weaker wood from old or younger individual with diameter used as a proxy for the "age".
```{r}
ggplot(lum, aes(x = Dawkins, y = espece, size = diameter))+
  geom_jitter()
```

