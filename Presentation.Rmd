---
title: "Presentation"
author: "Emilie Ducouret"
output:
  html_document:
    highlight: pygments
    number_sections: yes
    theme: journal
    toc: yes
    toc_depth: 5
    toc_float: yes
---


```{r setup, include=FALSE}
rm(list = ls())


library(dplyr)
library(FactoMineR)
library(factoextra)
library(ggplot2)
library(ggpubr)
library(RColorBrewer)
library("gridExtra")
library("cowplot")
library(kableExtra)
library(ggrepel)

path <- "C:\\Users\\emduc\\Desktop\\Drive\\symphostage\\"

```


```{r include=FALSE}
environment_trait<- read.csv(file.path(path, "environment_trait.csv"),header = T, dec = ".", sep=";") %>% 
  mutate(Dawkins = as.factor(Dawkins), ID= as.factor(paste(n_parcelle, n_carre, n_arbre, sep="_"))) %>% 
  rename(LDMC = LMDC , LT = LT_mean , LA = Area_exclude , Cc = Chloro_content, BT = Bark_thickness, BD = Bark_infra_density, WD = Wood_infra_density, Carbon = Carbonmean , Phosphorus = Phosphorme) %>% 
  dplyr::select(-flow_accum , -X , -ombrage, -wtd , -d_log_gap, -hydromorphy , -waterlog , -aspect , -drainages - basal_area, -wood_presence)

environment_trait$Dawkins[which(environment_trait$ID == "15_1_198")] <- "5"

#┴environment_trait %>%  filter( ID == "11_4_983" |ID == "11_1_742" | ID == "2_3_236" |ID == "1_2_387" |ID == "15_1_637" |ID == "15_1_198" )
```

Raw data set with 401 individuals, one does not match with Paracou identification names (14-2-459). An other one (15-1-198) does not have Dawkins value because it fall down before the sampling campain. As this individual was still alive trait measures have been done and with its relative height Dawkins level 5 has been assigned.

# Functional traits
## Description 



```{r echo=FALSE}
tab = matrix(NA, ncol = 4, nrow = 8)
tab <- as.data.frame(tab)
names(tab) <- c("Trait ","Unit","Short form", "Function")

tab$`Trait ` <- c("Specific Leaf Area", "Leaf Dry Matter Content", "Leaf Thickness", "Leaf Area", "Chlorophyll content", "Branch Bark Thickness" , "Branch Bark density" , "Branch Wood density ")

tab$Unit <-c("g.cm²","-microm","mm","cm²", "microg.cm-²","mm","-","-")

tab$`Short form`<- c("SLA", "LDMC","LT", "LA", "Cc", "BT", "BD", "WD")

tab$Function <- c("Acquisition", "", "", "Acquisition", "Acquisiton", "Protection, stockage", "", "")

kable(tab, "html") %>%  kable_styling(bootstrap_options = c("striped", "hover", "condensed","background-color :white"))

rm(tab)
```

The only variable that depict ontogenic stage is the diameter at breast height (DBH) .For every tree sapling and early ontogenic stage individual are in the underlayer of canopy and as we know light availability decrease from canopy to the ground. Irradiance is a very heterogeneous resource, and can be as high as 47 mol m−2 day−1 above the canopy and as low as 0·15 mol m−2 day−1 at the forest floor (Chazdon 1988). Thus functional response of younger tree to the environment would be different from older individual in different light condition. For example younger individual would have higher SLA value to maximise light interceptection and so their growth to reech the canopy layer.
Consequently diameter would modulate SLA value and other light modulated traits.  

## Outliers 

An outlier is an observation that is numerically distant from the rest of the data. When reviewing a boxplot, an outlier is defined as a data point that is located outside the fences (“whiskers”) of the boxplot (e.g: outside 1.5 times the interquartile range above the upper quartile and below the lower quartile).

```{r message=FALSE, warning=FALSE, include=FALSE}

outliers_data <- reshape::melt(environment_trait[,c("LT", "Cc", "SLA" , "LDMC", "LA", "ID")],id=c( "ID")) %>% rename(Trait = variable, Value = value)

is_outlier <- function(x) {
  return(x < quantile(x, 0.25) - 1.5 * IQR(x) | x > quantile(x, 0.75) + 1.5 * IQR(x))
}
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
SLA <- outliers_data %>%  filter( Trait == "SLA") %>%
  filter(!is.na(Value)) %>% 
  mutate(outlier = ifelse(is_outlier(Value), as.character(ID), NA)) %>%   
  ggplot( aes(Trait, Value))+
  geom_boxplot()+
  geom_text_repel(aes(label = outlier))+
  ggtitle("SLA outliers
          with Paracou name")+
  ylab("Value (g.cm²)")

LT <- outliers_data %>%  filter( Trait == "LT") %>% 
  filter(!is.na(Value)) %>%
  mutate(outlier = ifelse(is_outlier(Value), as.character(ID), NA)) %>%   
  ggplot( aes(Trait, Value))+
  geom_boxplot()+
  geom_text_repel(aes(label = outlier))+
  ggtitle("LT outliers 
          with Paracou name")+
  ylab("Value (mm)")

LDMC <- outliers_data %>%  filter( Trait == "LDMC") %>% 
  filter(!is.na(Value)) %>%
  mutate(outlier = ifelse(is_outlier(Value), as.character(ID), NA)) %>%   
  ggplot( aes(Trait, Value))+
  geom_boxplot()+
  geom_text_repel(aes(label = outlier))+
  ggtitle("LDMC outliers
          with Paracou name")+
  ylab("Value")

outliers_data %>%  filter( Trait == "LA") %>% 
  filter(!is.na(Value)) %>%
  mutate(outlier = ifelse(is_outlier(Value), as.character(ID), NA)) %>%   
  ggplot( aes(Trait, Value))+
  geom_boxplot()+
  geom_text_repel(aes(label = outlier))+
  ggtitle("LA outliers 
          with Paracou name")+
  ylab("Value (cm²)")

Cc <-outliers_data %>%  filter( Trait == "Cc") %>%
  filter(!is.na(Value)) %>%
  mutate(outlier = ifelse(is_outlier(Value), as.character(ID), NA)) %>%   
  ggplot( aes(Trait, Value))+
  geom_boxplot()+
  geom_text_repel(aes(label = outlier))+
  ggtitle("Cc outliers  
          with Paracou name")+
  ylab("Value (microg.cm²)")

plot_grid(SLA, LT, ncol = 2, nrow = 1, align = "h")
plot_grid(LDMC, Cc, ncol= 2, nrow = 1, align = "h")

rm("SLA", "LDMC", "LT", "Cc", "outliers_data")
```

We found four outliers for SLA according to boxplot analysis, 11-1-742 and 11-4-983 have really aberrant value ( SLA > 400). Probably because their leaf area value is considered as superior outliers (Leaf area third quartile = 31.020  ; respective LA value : 73.9390 cm² and 63.1956 cm² ) and their dry weight value as inferior outliers ( Dry mass first quartile = 0.1480 ; respective dry mass value : 0.0878g and 0.1290g). Dry mass value seems to be very low for such big leaves, maybe it is an measure error, to be careful these values will be removed from the data set. Individuals number 13-2-73 and 15-1-198 are respectively a slight  LA outliers (37.9462cm²) and a slight Dry mass outliers (0.1456g) as deviation from global distribution is really small, they can be considered as maximum range values for SLA.


We found only one outlier (15_1_637) for leaf chlorophyll content. The fifth leaf of this individual have really small mean SPAD value ( SPAD first quartile = 59.80 ; value = 28.83 ) and it negatively influence the mean SPAD value of this individual. Leaf chlorophyll content is negatively influenced by the ontogenic stage and the considered value is lower than the global distribution so is could be due to non mature leaf. Consequently, we chose to remove these outlier.
We detected seven outliers for LDMC, we only chose to remove most deviant individuals : 2_3_236 and 1_2_387 (dry weight first quartile =  0.1480 and third quartile = 0.3162 ; respective value : 0.4132g and 0.0874g ). 
Finally, we detected 20 outliers for leaf area corresponding to natural variation (i.e. young individuals can have big leaves). 


```{r include=FALSE}
rm(outliers_data)

environment_trait$SLA[which(environment_trait$ID == "11_1_742"| environment_trait$ID == "11_4_983")] <- NA

environment_trait$LDMC[which(environment_trait$ID == "2_3_236" |environment_trait$ID == "1_2_387")] <- NA

environment_trait$Cc[which(environment_trait$ID == "15_1_637")] <- NA

```

## trait distribution 


```{r trait distribution, echo=FALSE, message=FALSE, warning=FALSE}

SLA <- ggplot(environment_trait, aes(SLA))+
  geom_histogram()

LDMC <- ggplot(environment_trait, aes(LDMC))+
  geom_histogram()
LT <- ggplot(environment_trait, aes(LT))+
  geom_histogram()
Chloro <- ggplot(environment_trait, aes(Cc))+
  geom_histogram()
Area <- ggplot(environment_trait, aes(LA))+
  geom_histogram()
 Area.log <- ggplot(environment_trait, aes(log10(LA)))+
  geom_histogram()

plot_grid(SLA, LDMC, LT, Chloro, Area ,Area.log , ncol = 2, nrow = 3)

rm("SLA", "LDMC", "LT", "Chloro", "Area")
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
BT <- ggplot(environment_trait, aes(BT))+
  geom_histogram()
BD <- ggplot(environment_trait, aes(BD))+
  geom_histogram()
WD<- ggplot(environment_trait, aes(WD))+
  geom_histogram()

plot_grid(BT, BD, WD, ncol = 2, nrow = 2)

rm("BT", "BD", "WD")
```

```{r include=FALSE}
environment_trait <- environment_trait %>% mutate(LA = log10(LA))
```

# Environmental variables
## Description 

```{r echo=FALSE}
tab2 = matrix(NA, ncol = 6, nrow = 13)
tab2 <- as.data.frame(tab2)
names(tab2) <- c("Variable","Unit","Short form", "Description", "Category", "Comment")

tab2$Variable <- c("Distance to the nearest creek"  ,"Digital Elevation Model", "Slope" ,"Curvature" ,"Topographic Ruggedness Index","Topographic Wetness Index","Relative altitude to the nearest creek" ,"Distance to the nearest canopy gap"
 ,"Soil Carbon concentration" ,"Soil Phosphorus concentration" , "Dawkins", "Diameter at breast Height","Local Basal Area  (Steneker and Jarvis 1963) ")

tab2$Unit <-c("meter","meter","-","-", "-", "-","meter", "meter","meter", "","-", "cm","m²")

tab2$`Short form`<- c("d_creek", "DEM","Slope", "Curvature", "TRI", "TWI", "alt_creek", "d_gap",  "C", "P", "Dawkins", "Diameter","lBAL")

tab2$Category <- c(rep("Abiotic",10), rep("Biotic", 3))

tab2[9:10,6] <- c(rep("only for 169 individuals",2))

#tab2[13,6] <- c("$$lBAL \equiv \sum_{j\equiv1}^nBA_j ,\ where\ i\ \ne j$$")

tab2$Description <- c("Water avalaibility", "Altitude, Nutrients avalaibility, Dryness","Nutrients avalaibility", "","", "Water avalaibility","Water avalaibility, Dryness", "Light avalaibility from treefall gap","Nutrient avalaibility","Nutrient avalaibility", "Canopy light exposition", "Ontogenic stage","Neighors competition index for light, nutrients and water")

kable(tab2, "html") %>%  kable_styling(bootstrap_options = c("striped", "hover", "condensed","background-color :white")) 

rm(tab2)
```

Interaction between diameter and different environmental variables will be added in the additive linaer model given that neighbors competition impact (lBAL) is modulated by diameter of the focal tree. As an hight tree which already reech the canopy would be less affect by crowding and shadowing neighbors effect. Moreover diameter also interact with d_gap because bigger tree could benefit more from gap light than a smaller one close to the same gap. This is the same idea for bottom land (wetness value  between 1.395 and 8.010 according to topographic category from F.Morneau (2007)) and diameter because bottom land area in guyanian tropical rain forest are known to be more biologically dynamic which means stand renewal is faster due more frequent tree fall which induce more light gap. An other particularity of bottom land is that the mean canopy height is lower than other areas like slope and hilltop (voir cours stéphane B.ferry ?), so wetness maybe modulate positively light availability.



## Covariation 


```{r environment standar, include=FALSE}
environment_standar <- environment_trait %>% 
  dplyr::select(n_parcelle, n_carre, n_arbre, Dawkins, lBAL,wetness,   d_creek,dem,slope, d_gap, alt_creek, TRI, curvature) %>% 
  mutate(alt_creek = as.numeric(alt_creek), Dawkins = as.factor(Dawkins))  

environment_standar[,5:13] <- as.data.frame(scale(as.matrix(environment_standar[,5:13]),scale = TRUE, center = TRUE)) 

```


```{r echo=FALSE}
acp_envi <- PCA(environment_standar[,5:13], graph =  FALSE)
fviz_pca_var (acp_envi , axes = c(1, 2), scaling =2, col.var = "contrib")
fviz_screeplot(acp_envi, ncp=10)
```

63.1% of the total inertia is explained by the first factorial plan. Selected environmental variable are wetness, lBAL, alt_creek, d_gap and aspect as they are less correlated variables in this dataset .

```{r echo=FALSE}
environment_standar <- environment_standar %>% 
  dplyr::select(-slope, -d_creek, -dem, -curvature, -TRI)

acp_envi <- PCA(environment_standar[,5:8], graph =  FALSE)
fviz_pca_var (acp_envi , axes = c(1, 2), label ="var", scaling =2, col.var = "contrib")
```

74.6% of the total inertia is explained by the first factorial plan.

### adding soil data (C, P)

This subset of the main data set brings information about carbon and phosphorus soil concentration at the sampled individual place (mean). 


```{r echo=FALSE}
envi_soil <-  environment_trait %>%  filter(!is.na(Carbon)) %>% 
  dplyr::select(Dawkins, diameter, Carbon, Phosphorus ,wetness,lBAL, d_gap, alt_creek ,SLA , LT, Cc, LA, LDMC, BT, BD, WD) %>% 
  mutate(alt_creek = as.numeric(alt_creek))

envi_soil[,2:16] <- as.data.frame(scale(as.matrix(envi_soil[,2:16]),scale = TRUE, center = TRUE)) 

acp_soil <- PCA(envi_soil[,3:8], graph =  FALSE)
fviz_pca_var (acp_soil , axes = c(1, 2), label ="var", scaling =2, col.var = "contrib")
fviz_screeplot(acp_soil, ncp=10)

```

65.1% of the total inertia is explain by he first factorial plan so others will be not show or look here. Phosphore is  positively correlated to wetness whereas Carbon soil concentration is negatively correlated to wetness.  It means that Phosphor concentration are higher in dryer area (i e hilltop and slope) whereas Carbon is value are higher in wetter area (i e bottomland).


# How does functional traits covariate at the intra-specific scale ? 
## Leaf functional traits

```{r trait standar, include=FALSE}
trait_standar <- environment_trait %>%
  dplyr::select(n_parcelle, n_carre, n_arbre,LT, Cc, LDMC, SLA, LA) 

trait_standar[,4:8] <- as.data.frame(scale(as.matrix(trait_standar[,4:8]), center = TRUE, scale = TRUE))
```
  
```{r echo=FALSE, message=FALSE, warning=FALSE}
trait.pca <- PCA(trait_standar[,4:8], graph = F)
fviz_pca_biplot(trait.pca , axes = c(1, 2), label ="var", scaling =2, col.var="contrib", col.ind="grey")
fviz_screeplot(trait.pca, ncp=10)
```

Projection of the first and second axis explain 76.3% of the total inertia, only the first factorial plan is retained. PCA is realized with 401 observations and standardized data (z-score method) but  results does not change with raw data. Chlorophyll content and LDMC are highly correlated and both are negatively correlated to Leaf area.  SLA and Leaf thickness are opposed , weakly correlated to the other variables. 

## Leaf and Wood functional trait 

```{r include=FALSE}
bois <- environment_trait %>%  filter(!is.na(BT)) %>%  dplyr::select(-Branch_diameter)
bois[,13:20] <- as.data.frame(scale(as.matrix(bois[,13:20]), center = TRUE, scale = TRUE))
```

```{r echo=FALSE}
trait_bois_pca <- PCA(bois[,13:20], graph = F)
fviz_pca_biplot(trait_bois_pca, axes = c(1, 2), label ="var", scaling =2, col.var = "contrib", col.ind="grey")
fviz_screeplot(trait_bois_pca, ncp=10)
```

Projection of the first and second axis explain 60.2% of the total inertia, only the first factorial plan is retained. PCA is realized with 50 observations and standardized data (z-score method), results does not change with raw data.  We can see that relation between leaf functional trait stay  identical. Then smaller individuals headcount does not influence functional trait relation in this functional trait correlation analysis. 

# Is intraspecific trait variability equal for every functional trait ?

The most simple way to calculate the intraspecific variability of a functional trait is the coefficient of variation (in %) for this trait (Messier *et al,* 2016 ; Fajardo and Piper 2011;  Jung *et al,* 2010). It is an dimensionless value that allowed to compare the range of value for each functional trait.  Coefficient of variation is calculated on raw data with any standardisation or transformation (as it could be log10 transformed for Leaf area) 

```{r include=FALSE}
CV <- function(mean, sd){
      (sd/mean)*100
      }
```

```{r echo=FALSE}
mean_data <- environment_trait %>% 
  dplyr::select( SLA, LDMC, LT, Cc, LA) %>% 
   summarize_at(c("SLA", "LDMC", "LT", "Cc", "LA"), mean, na.rm = T)

sd_data <- environment_trait %>% 
  dplyr::select( SLA, LDMC, LT, Cc, LA) %>% 
   summarize_at(c("SLA", "LDMC", "LT", "Cc", "LA"), sd, na.rm = T)

CV_data <- CV(mean = mean_data , sd= sd_data) 

CV_data[1,6] <- "Coeffcient of variation"

CV_data <- CV_data[, c("V6", "SLA", "LDMC", "LT", "LA", "Cc")] %>% rename(" "=V6)

CV_data %>%   kable("html") %>% kable_styling()

rm("CV", "sd_data", "mean_data","CV_data")
```

The total variation differs between traits : Leaf area is the most variable trait with 56% of variation followed by SLA (46.6%). Then Leaf thickness (27.6%) and Chlorophyll content (15.6%) are two or three time less variable than  SLA and Leaf area. Finally the least variable functional trait is LDMC with only 11.7%.

As different diameter classes have been sampled does it means that LDMC is a more conservative trait through ontogenic stage whereas SLA and Leaf area are highly variable ?

# How variance is partionned between sampling scales ?

## Variance partitionning analysis 

Variance component analysis gives the amount of variation that can be attributed to each different factor that can be used to defined an observation because random factor levels are chosen at random from a large or infinite set of levels,  variance could be attribute to choice of factor we have made. In our case several factor can be taking into account : where it have been sampled (plot number), which morphotype it is (here bark morphotype from field campagne data)  , which individual , which leaf of this individual is considered. The last factor is nested into the individual strata. 
The linear mixed model is designed to introduce random effect in the formula. The formula used for the variance component analysis is the following one based on Messier *et al* (2010)  for each studied functional trait (SLA, LDMC, LT ,LA and Cc) , four strata has been defined plot (Paracou parcelle) morphotype type (Globulifera, hybrid or Sp.1), individual and leaves (5 samples for each tree except for 5 individuals). Result of varcomp function show the fraction of variance explained by each strata plus an additive strata (automatically named “Within”, Venables and Ripley, 2002) of the component of variance with the studied variable (Solomon 2005) plus the model error. 

```{r eval=FALSE}
varcomp.SLA<-varcomp(lme(SLA~1,random=~1|n_parcelle/morphotype_field/n_arbre/n_feuille, data = varcomp_data ,na.action = na.omit),1)
```



```{r message=FALSE, warning=FALSE, include=FALSE}
library(ape)
library(nlme)

varcomp_data <- read.csv(file.path(path, "varcomp_data.csv"),header = T, dec = ".", sep=",") %>% 
filter(SLA < 400) %>% 
filter(!(LMDC < 0.17 |LMDC > 0.55)) %>% 
 filter(! Chloro_content < 40.5) 

varcomp_data[,9:13] <- as.data.frame(scale(as.matrix(varcomp_data[,9:13]), center = TRUE, scale = TRUE))
```


```{r include=FALSE}
varcomp.SLA2<-varcomp(lme(SLA~1,
random=~1|n_parcelle/topo/morphotype_field/n_arbre/n_feuille, data = varcomp_data ,na.action = na.omit),1)
```

```{r varcomp lmdc 2, include=FALSE}
varcomp.LDMC2<-varcomp(lme(LMDC~1,
random=~1|n_parcelle/topo/morphotype_field/n_arbre/n_feuille, data = varcomp_data ,na.action = na.omit),1)
```

```{r include=FALSE}
varcomp.LT2<-varcomp(lme(LT_mean~1,
random=~1|n_parcelle/topo/morphotype_field/n_arbre/n_feuille, data = varcomp_data ,na.action = na.omit),1)
```


```{r include=FALSE}
varcomp.Area2<-varcomp(lme(Area_exclude~1,
random=~1|n_parcelle/topo/morphotype_field/n_arbre/n_feuille, data = varcomp_data ,na.action = na.omit),1)
```

```{r include=FALSE}
varcomp.Chloro2<-varcomp(lme(Chloro_content~1,
random=~1|n_parcelle/topo/morphotype_field/n_arbre/n_feuille, data = varcomp_data ,na.action = na.omit),1)
```


```{r include=FALSE}

varcomp_resu2 <- as.data.frame(cbind(varcomp.Area2, varcomp.LDMC2, varcomp.LT2, varcomp.SLA2, varcomp.Chloro2))

  varcomp_resu2 <- varcomp_resu2 %>% mutate( niveau = rownames(varcomp_resu2)) %>% 
    dplyr::rename(LA = "varcomp.Area2", LT="varcomp.LT2", LDMC = "varcomp.LDMC2", SLA = "varcomp.SLA2", Cc= "varcomp.Chloro2") 
  
varcomp_resu2$niveau <- factor(varcomp_resu2$niveau, levels = varcomp_resu2$niveau)    

varcomp_resu2 <- reshape::melt(varcomp_resu2,  id=c("niveau")) %>% 
  mutate(value1 = as.integer(value*100)) %>%  
  mutate(niveau = as.factor(niveau))
  
rm("varcomp.Chloro2", "varcomp.SLA2", "varcomp.LDMC2", "varcomp.LT2", "varcomp.Area2")
```


```{r echo=FALSE}
 ggplot(varcomp_resu2,aes(x = variable, y = value1, fill = niveau, order= niveau))+
  geom_bar(stat = "identity", position = "stack")+
  labs(title = "Variance component analysis", y = "fraction of the total variance explained
       by each scale (value*100) ", x= "functional trait")+
  scale_fill_brewer(palette="PiYG")+
  geom_text(aes(label = value1, group = niveau),position = position_stack(vjust = 0.5))
```


```{r varcomp SLA, include=FALSE}
varcomp.SLA<-varcomp(lme(SLA~1,
random=~1|n_parcelle/morphotype_field/n_arbre/n_feuille, data = varcomp_data ,na.action = na.omit),1)
```

```{r varcomp LMDC, include=FALSE}
varcomp.LDMC<-varcomp(lme(LMDC~1,
random=~1|n_parcelle/morphotype_field/n_arbre/n_feuille, data = varcomp_data ,na.action = na.omit),1)
```

```{r varcomp LT, include=FALSE}
varcomp.LT<-varcomp(lme(LT_mean~1,
random=~1|n_parcelle/morphotype_field/n_arbre/n_feuille, data = varcomp_data ,na.action = na.omit),1)
```


```{r varcomp Area, include=FALSE}
varcomp.Area<-varcomp(lme(Area_exclude~1,
random=~1|n_parcelle/morphotype_field/n_arbre/n_feuille, data = varcomp_data ,na.action = na.omit),1)
```

```{r varcomp chloro, include=FALSE}
varcomp.Chloro<-varcomp(lme(Chloro_content~1,
random=~1|n_parcelle/morphotype_field/n_arbre/n_feuille, data = varcomp_data ,na.action = na.omit),1)
```


```{r varcomp resu, include=FALSE}

varcomp_resu <- as.data.frame(cbind(varcomp.Area, varcomp.LDMC, varcomp.LT, varcomp.SLA, varcomp.Chloro))

  varcomp_resu <- varcomp_resu %>% mutate( niveau = rownames(varcomp_resu)) %>% 
    dplyr::rename(Area = "varcomp.Area", LT="varcomp.LT", LDMC = "varcomp.LDMC", SLA = "varcomp.SLA", Chloro = "varcomp.Chloro")
  
varcomp_resu$niveau <- factor(varcomp_resu$niveau, levels = varcomp_resu$niveau)    

varcomp_resu <- reshape::melt(varcomp_resu,  id=c("niveau")) %>% 
  mutate(value1 = as.integer(value*100)) %>% 
  mutate(niveau = as.factor(niveau))

rm("varcomp.Chloro", "varcomp.SLA", "varcomp.LDMC", "varcomp.LT", "varcomp.Area2")
```


```{r varcomp plot, echo=FALSE}
ggplot(varcomp_resu,aes(x = variable, y = value1, fill = niveau, order= niveau))+
  geom_bar(stat = "identity", position = "stack")+
  labs(title = "Variance component analysis", y = "fraction of the total variance explained
       by each scale (value*100) ", x= "functional trait")+
  scale_fill_brewer(palette="PiYG")+
  geom_text(aes(label = value1, group = niveau),position = position_stack(vjust = 0.5))
```


## Why Leaf thickness is influenced by plot levels ?



```{r include=FALSE}
rain <- read.csv(file.path(path, "Donnes_tour_a_flux.csv"),header = T, dec = ",", sep=";") %>% dplyr::select(Ann.e, Mois, jour, Pluie) %>%  
  filter(Mois =="Novembre" | Mois == "Decembre" | Mois == "Octobre")

environment_trait <- environment_trait %>%  mutate(n_parcelle = as.factor(n_parcelle))
```



```{r pluie-date, include=FALSE}
rain <- rain %>%  group_by(Ann.e, Mois,  jour) %>% summarize_at(c( "Pluie") , mean, na.rm = T)

rain_novembre <- rain %>%  filter((Mois == "Novembre")) %>% 
  mutate(jour2 = row.names(.)) %>% 
  mutate(mois2 = 11)

rain_december <- rain %>%  filter((Mois == "Decembre")) %>% 
  mutate(jour2 = row.names(.))%>% 
  mutate(mois2 = 12)

rain_october <- rain %>%  filter((Mois == "Octobre")) %>% 
  mutate(jour2 = row.names(.))%>% 
  mutate(mois2 = 10)

rain_date <- full_join(rain_december,rain_novembre, by = c("Ann.e", "Mois", "jour", "Pluie", "jour2", "mois2"))  
```


```{r include=FALSE}
rain_date <- full_join(rain_date,rain_october, by = c("Ann.e", "Mois", "jour", "Pluie", "jour2", "mois2"))  %>% 
  mutate(jour2 = as.numeric(jour2)) %>% 
  mutate(Date = ifelse((jour2 < 10),  paste(paste(0,jour2, sep=""), mois2, Ann.e, sep="/"), paste(jour2, mois2, Ann.e, sep="/")))

rm("rain_december","rain_novembre" , "rain", "rain_october")
```


```{r trait-date, include=FALSE}

Measures_Individuals2 <- read.csv(file.path(path, "Measures - Individuals.csv"),header = T, dec = ".", sep=",") %>% 
  dplyr::rename( n_parcelle = "Plot" , n_carre = "Subplot" , n_arbre = "Tree") %>% 
  mutate(n_parcelle = as.factor(n_parcelle))

data <- left_join(environment_trait, Measures_Individuals2, by = c("n_parcelle" , "n_carre" , "n_arbre")) %>% 
  mutate( n_parcelle = as.factor(n_parcelle)) %>% 
  select(n_parcelle, n_carre, n_arbre, LT , Cc ,SLA , LDMC, LA, Date)

```


```{r combine trait-rain, include=FALSE}
data_rain <- left_join(data, rain_date, by="Date") %>% 
  mutate(n_parcelle = as.factor(n_parcelle))
```



```{r echo=FALSE}
environment_trait %>%  mutate( n_parcelle = as.factor(n_parcelle)) %>%
  ggplot( aes(n_parcelle,LT, fill = traitement))+
  geom_boxplot()+
    stat_compare_means(method = "anova", 
                     label.y = 525, label.x = 2) +
  stat_compare_means(method = "t.test", 
                     aes(label = ..p.signif..),
                     ref.group = ".all.",
                     label.y = 505)+
  geom_hline(yintercept = mean(environment_trait$LT), linetype = 2)+
  ggtitle("Leaf thickness distribution in each plot")
```



```{r echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(scales)
data %>% 
  select(Date, n_parcelle, LT, SLA, LDMC, Cc, LA) %>% 
  mutate( n_parcelle = as.factor(n_parcelle)) %>% 
  reshape2::melt(id = c("Date", "n_parcelle"), variable.name = "Trait") %>% 
  ggplot(aes(as.Date(Date, format = "%d/%m/%Y"), value, col = n_parcelle)) +
  geom_point() +
  scale_x_date(labels = date_format("%b")) +
  facet_wrap(~Trait, scales = "free")
```



```{r echo=FALSE}
data2<- data %>%  group_by(Date, n_parcelle) %>%  summarize_at(c( "LT") , mean, na.rm = T)

ggplot(data2, aes(as.Date(data2$Date, format = "%d/%m/%Y"), LT, col = n_parcelle)) + 
geom_point() +
  geom_text_repel(aes(label = data2$n_parcelle))
```


```{r echo=FALSE}

data_rain3 <- data_rain %>%  group_by(Date, n_parcelle, Pluie) %>%  summarise() 

ggplot(data_rain3,aes(as.Date(data_rain3$Date, format = "%d/%m/%Y"),Pluie, color = n_parcelle )) + 
geom_point()+
  geom_text_repel(aes(label = data_rain3$n_parcelle))
```


```{r echo=FALSE}
ggplot(environment_trait, aes((n_parcelle),(diameter) ))+
  geom_boxplot()+
stat_compare_means(method = "anova", 
                     label.y = 90, label.x = 2) +
  stat_compare_means(method = "t.test", 
                     aes(label = ..p.signif..),
                     ref.group = ".all.",
                     label.y = 85)+
  geom_hline(yintercept = mean(environment_trait$diameter), linetype = 2)
```


```{r echo=FALSE}
ggplot(environment_trait, aes(diameter, LT, color = Dawkins ))+
  geom_point()
```

```{r echo=FALSE}
LT_model <-lm(LT~diameter, data= environment_trait)
summary(LT_model)
par(mfrow = c(2,2))
plot(LT_model)
```

#  How envrionmental variables influence functional trait distribution ? 

```{r include=FALSE}
environment_trait$SLA[which(environment_trait$ID == "11_1_742"| environment_trait$ID == "11_4_983")] <- NA

environment_trait$LDMC[which(environment_trait$ID == "2_3_236" |environment_trait$ID == "1_2_387")] <- NA

environment_trait$Cc[which(environment_trait$ID == "15_1_637")] <- NA

data_standar<- environment_trait %>% 
  dplyr::select(n_parcelle, n_carre, n_arbre,Branch_diameter,  Dawkins,diameter,  lBAL, wetness, alt_creek, d_gap, Carbon, Phosphorus, SLA, LA, LT, LDMC, Cc, BT, BD, WD) %>% 
  mutate(Dawkins = as.factor(Dawkins), n_parcelle = as.factor(n_parcelle), alt_creek = as.numeric(alt_creek), LA = log10(LA))

data_standar [,6:20]<- as.data.frame(scale(as.matrix(data_standar[,6:20]),scale = TRUE, center = TRUE)) 

envi_soil <-  environment_trait %>%  filter(!is.na(Carbon)) %>% 
  dplyr::select(Dawkins, diameter, Carbon, Phosphorus ,wetness,lBAL, d_gap, alt_creek ,SLA , LT, Cc, LA, LDMC, BT, BD, WD) %>% 
  mutate(alt_creek = as.numeric(alt_creek))

envi_soil[,2:16] <- as.data.frame(scale(as.matrix(envi_soil[,2:16]),scale = TRUE, center = TRUE))
```
Standardized data and LA log10 transformed

##  Multi trait linear analysis : RDA
### Leaf traits

```{r message=FALSE, warning=FALSE, , message=FALSE, include=FALSE}
library(ade4)
library(vegan)
library(MASS)
library(ellipse)

```

```{r include=FALSE}
trait_center <- environment_trait %>%
  dplyr::select(LT, Cc, LDMC, SLA, LA) %>% filter(!is.na(SLA)) %>% 
  filter(!is.na(Cc)) %>% 
  filter(!is.na(LDMC))

trait_center <- as.data.frame(scale(as.matrix(trait_center), center = TRUE, scale =  FALSE))

data_standar <- data_standar %>% filter(!is.na(SLA)) %>% 
  filter(!is.na(Cc)) %>% 
  filter(!is.na(LDMC))
```

```{r include=FALSE}
rda_trait <- rda(trait_center,data_standar[,6:10],scale = T, na.omit= T)

```


```{r echo=FALSE}
library(ggvegan)

autoplot(rda_trait, arrows = TRUE, legend = "none",layers = c("species", "sites", "biplot", "centroids") )
```

### Wood traits 



```{r include=FALSE}
trait_center2 <- environment_trait %>%
  filter(!is.na(BT)) %>% 
  dplyr::select( BT, BD, WD)
 

trait_center2 <- as.data.frame(scale(as.matrix(trait_center2), center = TRUE, scale =  FALSE))

envi_rda <- environment_trait %>% 
  dplyr::select( lBAL,wetness,   d_creek, d_gap, alt_creek, BT, Cc, LDMC, SLA) %>% 
  mutate(alt_creek = as.numeric(alt_creek)) %>%  
  filter(!is.na(BT)) %>% 
  filter(!is.na(SLA)) %>% 
  filter(!is.na(Cc)) %>% 
  filter(!is.na(LDMC))

envi_rda <- as.data.frame(scale(as.matrix(envi_rda),scale = TRUE, center = TRUE)) 
```

```{r include=FALSE}
rda_trait2 <- rda(trait_center2,envi_rda[1:5],scale = T, na.omit= T)
```

```{r echo=FALSE}
autoplot(rda_trait2, arrows = TRUE, legend = "none", geom = "text")+
  geom_text_repel()
```

##  Univariate analysis : linear model

Functional traits and environmental variables are standardized by z-score method. Interaction between focal tree diameter and sum of  the local basal area (lBAL) is added to the following model as neighbor competition effect is vary according to the focal tree diameter. 

### SLA model 
#### general environment

```{r SLA mixte, eval=FALSE, include=TRUE}

SLA_model <-lm(formula = data_standar$SLA ~ Dawkins + diameter + diameter:lBAL + lBAL + wetness + d_gap + alt_creek +diameter:wetness + diameter:d_gap  , data = data_standar[,5:10])
step(SLA_model, direction = "both")

```


```{r echo=TRUE}
SLA_model <- lm(formula = data_standar$SLA ~ Dawkins + diameter + d_gap, data = data_standar[, 5:10])
summary(SLA_model)
```


```{r echo=FALSE}
par(mfrow = c(2,2))
plot(SLA_model)
```
  
Linear Models: the absolute value of the t--statistic for each model parameter is used.
```{r message=FALSE, warning=FALSE, include=FALSE}
library(caret)

Imp_SLA<- varImp(SLA_model, nonpara = FALSE)

Imp_SLA <- Imp_SLA %>%  mutate(Variables = row.names(Imp_SLA), Trait = rep("SLA", nrow(Imp_SLA))) %>% 
  rename(Importance = Overall)
```

  
#### adding soil data


```{r  eval=FALSE, include=TRUE}
envi_soil <- envi_soil %>%  filter(!is.na(Dawkins))

SLA_soil <- lm(formula = envi_soil$SLA ~Dawkins + diameter + diameter:lBAL + lBAL + wetness + d_gap + alt_creek+Carbon + Phosphorus, data = envi_soil[,1:8])

step(SLA_soil , direction = "both")
```


```{r include=FALSE}
SLA_soil <-lm(formula = envi_soil$SLA ~ Dawkins + diameter + wetness, data = envi_soil[, 1:8]) 
```

```{r include=FALSE}
Imp_SLA_soil<- varImp(SLA_soil, nonpara = FALSE)

Imp_SLA_soil<- Imp_SLA_soil%>%  mutate(Variables = row.names(Imp_SLA_soil), Trait = rep("SLA", nrow(Imp_SLA_soil))) %>% 
  rename(Importance = Overall)
```


###  LDMC model
#### general environment

```{r LDMC model 1, eval=FALSE, include=TRUE}
LDMC_model <- lm(data_standar$LDMC~Dawkins + diameter + diameter:lBAL + lBAL + wetness + d_gap + alt_creek +diameter:wetness + diameter:d_gap, data = data_standar[,5:10])

step(LDMC_model, direction = "both")
```

```{r LDMC model 2, echo=FALSE}

LDMC_model <- lm(formula = data_standar$LDMC ~ Dawkins + diameter + lBAL + 
    wetness + d_gap + diameter:lBAL, data = data_standar[, 5:10])

summary(LDMC_model)
```
 
```{r echo=FALSE}
par(mfrow = c(2,2))
plot(LDMC_model)
```

```{r include=FALSE}
Imp_LDMC<- varImp(LDMC_model, nonpara = FALSE)

Imp_LDMC <- Imp_LDMC %>%  mutate(Variables = row.names(Imp_LDMC), Trait = rep("LDMC", nrow(Imp_LDMC))) %>% 
  rename(Importance = Overall)
```

#### adding soil data


```{r  eval=FALSE, include=TRUE}
LDMC_soil <- lm(formula = envi_soil$LDMC ~Dawkins + diameter + diameter:lBAL + lBAL + wetness + d_gap + alt_creek +Carbon + Phosphorus , data = envi_soil[,1:8])

step(LDMC_soil , direction = "both")
```

```{r ,include=FALSE}
LDMC_soil <- lm(formula = envi_soil$LDMC ~ Dawkins + diameter + lBAL + wetness + diameter:lBAL, data = envi_soil[, 1:8])
```


```{r include=FALSE}
Imp_LDMC_soil<- varImp(LDMC_soil, nonpara = FALSE)

Imp_LDMC_soil<- Imp_LDMC_soil%>%  mutate(Variables = row.names(Imp_LDMC_soil), Trait = rep("LDMC", nrow(Imp_LDMC_soil))) %>% 
  rename(Importance = Overall)
```

### LT model 
#### general environment


```{r eval=FALSE, include=TRUE}
LT_model <- lm(data_standar$LT~Dawkins + diameter + diameter:lBAL + lBAL + wetness + d_gap + alt_creek +diameter:wetness + diameter:d_gap  , data = data_standar[,5:10])

step(LT_model, direction = "both")
```


```{r echo=FALSE}
LT_model <- lm(formula = data_standar$LT ~ Dawkins + diameter + lBAL + wetness + 
    diameter:lBAL + diameter:wetness, data = data_standar[, 5:10])

summary(LT_model)
```

```{r echo=FALSE}
par(mfrow = c(2,2))
plot(LT_model)
```


```{r}
Imp_LT<- varImp(LT_model, nonpara = FALSE)

Imp_LT <- Imp_LT %>%  mutate(Variables = row.names(Imp_LT), Trait = rep("LT", nrow(Imp_LT))) %>% 
  rename(Importance = Overall)
```

#### adding soil data 


```{r eval=FALSE, include=TRUE}

LT_soil <- lm(formula = envi_soil$LT ~Dawkins + diameter + diameter:lBAL + lBAL + wetness + d_gap + alt_creek + Carbon+ Phosphorus  , data = envi_soil[,1:8])

step(LT_soil,  direction = "both")
        
```

```{r echo=FALSE}
LT_soil <- lm(formula = envi_soil$LT ~ diameter + wetness + d_gap + Carbon, 
    data = envi_soil[, 1:8]) 
summary(LT_soil)
```


```{r include=FALSE}
Imp_LT_soil<- varImp(LT_soil, nonpara = FALSE)

Imp_LT_soil<- Imp_LT_soil%>%  mutate(Variables = row.names(Imp_LT_soil), Trait = rep("LT", nrow(Imp_LT_soil))) %>% 
  rename(Importance = Overall)
```


### Cc model 
#### general environment 

```{r eval=FALSE, include=TRUE}
Cc_model <- lm(data_standar$Cc~Dawkins + diameter + diameter:lBAL + lBAL + wetness + d_gap + alt_creek + diameter:wetness + diameter:d_gap, data = data_standar[,5:10])

step(Cc_model, direction = "both")
```

```{r echo=FALSE}
Cc_model <- lm(formula = data_standar$Cc ~ Dawkins + lBAL + wetness, data = data_standar[,5:10])

summary(Cc_model)
```


```{r echo=FALSE}
par(mfrow = c(2,2))
plot(Cc_model)
```

```{r}
Imp_Cc<- varImp(Cc_model, nonpara = FALSE)

Imp_Cc <- Imp_Cc %>%  mutate(Variables = row.names(Imp_Cc), Trait = rep("Cc", nrow(Imp_Cc))) %>% 
  rename(Importance = Overall)
```

#### adding soil data 


```{r eval=FALSE, include=TRUE}
Cc_soil <- lm(formula = envi_soil$Cc ~Dawkins + diameter + diameter:lBAL + lBAL + wetness + d_gap + alt_creek +Carbon + Phosphorus, data = envi_soil[,1:8])

step(Cc_soil,  direction = "both")
        
```

```{r echo=FALSE}
Cc_soil <- lm(formula = envi_soil$Cc ~ Dawkins + Carbon + wetness + lBAL + 
    alt_creek, data = envi_soil[, 1:8])
summary(Cc_soil)
```


```{r include=FALSE}
Imp_Cc_soil<- varImp(Cc_soil, nonpara = FALSE)

Imp_Cc_soil<- Imp_Cc_soil%>%  mutate(Variables = row.names(Imp_Cc_soil), Trait = rep("Cc", nrow(Imp_Cc_soil))) %>% 
  rename(Importance = Overall)
```

### LA model 
#### general environment

```{r eval=FALSE, include=TRUE}
LA_model <- lm(data_standar$LA~Dawkins + diameter + diameter:lBAL + lBAL + wetness + d_gap + alt_creek + diameter:wetness + diameter:d_gap, data = data_standar[,5:10])

step(LA_model, direction = "both")
```

```{r echo=FALSE}
LA_model <-lm(formula = data_standar$LA ~ Dawkins + lBAL + wetness + alt_creek, 
    data = data_standar[, 5:10])

summary(LA_model)
```


```{r echo=FALSE}
par(mfrow = c(2,2))
plot(LA_model)
```

```{r}
Imp_LA<- varImp(LA_model, nonpara = FALSE)

Imp_LA <- Imp_LA %>%  mutate(Variables = row.names(Imp_LA), Trait = rep("LA", nrow(Imp_LA))) %>% 
  rename(Importance = Overall)
```


#### adding soil data 


```{r eval=FALSE, include=TRUE}
LA_soil <- lm(formula = envi_soil$LA ~Dawkins + diameter + diameter:lBAL + lBAL + wetness + d_gap + alt_creek+Carbon+Phosphorus, data = envi_soil[,1:8])

step(LA_soil,  direction = "both")
        
```

```{r include=FALSE}
LA_soil <-lm(formula = envi_soil$LA ~ diameter + lBAL + wetness + alt_creek + 
    diameter:lBAL, data = envi_soil[, 1:8])
```


```{r include=FALSE}
Imp_LA_soil<- varImp(LA_soil, nonpara = FALSE)

Imp_LA_soil<- Imp_LA_soil%>%  mutate(Variables = row.names(Imp_LA_soil), Trait = rep("LA", nrow(Imp_LA_soil))) %>% 
  rename(Importance = Overall)
```


### BT model 
#### general environment


```{r eval=FALSE, include=TRUE}

BT_model <- lm(formula= data_standar$BT~Dawkins + diameter + diameter:lBAL + lBAL + wetness + d_gap + alt_creek + diameter:wetness + diameter:d_gap, data = data_standar[,5:10])
step(BT_model, direction = "both")
```

```{r echo=FALSE}
BT_model <- lm(formula = data_standar$BT ~ diameter + alt_creek, data = data_standar[,5:10])

summary(BT_model)
```

```{r echo=FALSE}
par(mfrow = c(2,2))
plot(BT_model)
```

```{r include=FALSE}
Imp_BT<- varImp(BT_model, nonpara = FALSE)

Imp_BT <- Imp_BT %>%  mutate(Variables = row.names(Imp_BT), Trait = rep("BT", nrow(Imp_BT))) %>% 
  rename(Importance = Overall)
```


#### adding soil data 

```{r eval=FALSE, include=TRUE}
BT_soil <- lm(formula = envi_soil$BT ~Dawkins + diameter + diameter:lBAL + lBAL + wetness + d_gap + alt_creek+ Carbon + Phosphorus, data = envi_soil[,1:8])

step(BT_soil,  direction = "both")
```

```{r echo=FALSE}
BT_soil <- lm(formula = envi_soil$BT ~ diameter + Carbon + wetness + lBAL, 
    data = envi_soil[, 1:8])  
summary(BT_soil)
```

```{r echo=FALSE}
par(mfrow = c(2,2))
plot(BT_soil)
```

Individual number 103 is really close to the Cook distance line 

And scale location should be linear.


```{r include=FALSE}
Imp_BT_soil<- varImp(BT_soil, nonpara = FALSE)

Imp_BT_soil<- Imp_BT_soil%>%  mutate(Variables = row.names(Imp_BT_soil), Trait = rep("BT", nrow(Imp_BT_soil))) %>% 
  rename(Importance = Overall)
```

### BD model 
#### general environment


```{r eval=FALSE, include=TRUE}

BD_model <- lm(formula= data_standar$BD~Dawkins + diameter + diameter:lBAL + lBAL + wetness + d_gap + alt_creek+ diameter:wetness + diameter:d_gap, data = data_standar[,5:10])
step(BD_model, direction = "both")
```

```{r echo=FALSE}
BD_model <- lm(formula = data_standar$BD ~ diameter + wetness + alt_creek + d_gap, data = data_standar[, 5:10])

summary(BD_model)
```

```{r echo=FALSE}
par(mfrow = c(2,2))
plot(BD_model)
```


```{r include=FALSE}
Imp_BD<- varImp(BD_model, nonpara = FALSE)

Imp_BD <- Imp_BD %>%  mutate(Variables = row.names(Imp_BD), Trait = rep("BD", nrow(Imp_BD))) %>% 
  rename(Importance = Overall)
```

#### adding soil data


```{r eval=FALSE, include=TRUE}
BD_soil <- lm(formula = envi_soil$BD ~Dawkins + diameter + diameter:lBAL + lBAL + wetness + d_gap + alt_creek+Carbon+Phosphorus, data = envi_soil[,1:8])

step(BD_soil,  direction = "both")
```

```{r echo=FALSE}
BD_soil <- lm(formula = envi_soil$BD ~ diameter + Carbon + wetness + lBAL, 
    data = envi_soil[, 1:8])  
summary(BD_soil)
```


```{r echo=FALSE}
par(mfrow = c(2,2))
plot(BD_soil)
```
Individual n°42 is over the Cook's distance line


```{r include=FALSE}
Imp_BD_soil<- varImp(BD_soil, nonpara = FALSE)

Imp_BD_soil<- Imp_BD_soil%>%  mutate(Variables = row.names(Imp_BD_soil), Trait = rep("BD", nrow(Imp_BD_soil))) %>% 
  rename(Importance = Overall)
```


### WD model 
#### general environment


```{r eval=FALSE, include=TRUE}

WD_model <- lm(formula= data_standar$WD~Dawkins + diameter + diameter:lBAL + lBAL + wetness + d_gap + alt_creek + diameter:wetness + diameter:d_gap, data = data_standar[,5:10])
step(WD_model, direction = "both")
```

```{r echo=FALSE}
WD_model <- lm(formula = data_standar$WD ~ diameter + wetness + d_gap + diameter:wetness +  diameter:d_gap, data = data_standar[, 5:10])

summary(WD_model)
```

```{r echo=FALSE}
par(mfrow = c(2,2))
plot(WD_model)
```


```{r include=FALSE}
Imp_WD<- varImp(WD_model, nonpara = FALSE)

Imp_WD <- Imp_WD %>%  mutate(Variables = row.names(Imp_WD), Trait = rep("WD", nrow(Imp_WD))) %>% 
  rename(Importance = Overall)
```


#### adding soil data 

```{r eval=FALSE, include=TRUE}
WD_soil <- lm(formula = envi_soil$WD ~Dawkins + diameter + diameter:lBAL + lBAL + wetness + d_gap + alt_creek+ Carbon +Phosphorus, data = envi_soil[,1:8])

step(WD_soil,  direction = "both")
```

```{r echo=FALSE}
WD_soil <- lm(formula = envi_soil$WD ~ diameter + Phosphorus + wetness + 
    d_gap, data = envi_soil[, 1:8])
summary(WD_soil)
```


```{r echo=FALSE}
par(mfrow = c(2,2))
plot(WD_soil)
```


```{r include=FALSE}
Imp_WD_soil<- varImp(WD_soil, nonpara = FALSE)

Imp_WD_soil<- Imp_WD_soil%>%  mutate(Variables = row.names(Imp_WD_soil), Trait = rep("WD", nrow(Imp_WD_soil))) %>% 
  rename(Importance = Overall)
```



## How each environmental factor influence the distribution of trait ? 

Explicative variable coefficient (Beta) sign table with significative codes of F-statistic. Coefficient signs are from additive linear model fitted by step procedure with AIC criterion for each studed trait. As step method is less perfoment when n/p ratio < 20 where n is sampled headcount (402; 169 or 50) and p model parameters (13). Model for wood functional traits doesn't have been fitted with diameter and d_gap or wetness interaction. And also model fitted with soil data (Carbon and Phosphorus soil concentration.

```{r echo=FALSE}
model_tab = matrix(NA, ncol = 9, nrow = 16)
model_tab <- as.data.frame(model_tab)

names(model_tab)<- c("Variables","Specific Leaf Area", "Leaf Dry Matter Content", "Leaf Thickness", "Leaf Area","Chlorophyll content", "Branch Bark Thickness" , "Branch Bark density" , "Branch Wood density ")

model_tab$Variables<- c("Intercept","Dawkins2","Dawkins3","Dawkins4","Dawkins5","Diameter"," lBAL  ","Diameter:lBAL", "Wetness","d_gap","alt_creek", "Diameter:wetness","Diameter:d_gap", "Carbon", "Phosphorus", "Adjusted R²")

model_tab$`Specific Leaf Area`<- c("[+]***","[-]***","[-]***","[-]***","[-]***","[-].",NA,NA,NA,"[-].",NA,NA,NA,NA,NA,"0.3452")

model_tab$`Leaf Dry Matter Content`<-  c("[-] ***","[+]*","[+]***","[+]***","[+]***","[+]","[+]","[+]*", "[-]***","[+]*",NA,NA, NA,NA,NA,"0.298")

model_tab$`Leaf Area` <- c("[+]***","[+]","[+]***","[+]***","[+]***",NA,"[+]***",NA,"[+]***",NA,"[+]***",NA,NA,NA,NA,"0.353 ")

model_tab$`Chlorophyll content`<- c("[+]***","[+]**","[+]***","[+]***","[+]***","[+]*",NA,NA,"[-]***",NA,NA,NA,NA,"[-]",NA,"0.1701")

model_tab$`Leaf Thickness`<- c("[-]*","[+]","[+]","[+]*","[+]**","[+]***","[-]**","[-]*", "[+]**",NA,NA,"[-]","[-].","[-]*",NA,"0.2797 ")

model_tab$`Branch Bark Thickness`<- c("[+]",NA,NA,NA,NA,"[+]***",NA,NA,NA,NA,"[-]*","-","-","[+]**",NA,"0.2929")

model_tab$`Branch Bark density` <- c("[+].",NA,NA,NA,NA,"[-].",NA,NA,"[-]*","[+]","[+]","-","-","[+]",NA,"0.4235")

model_tab$`Branch Wood density ` <- c("[-]",NA,NA,NA,NA,"[-]**",NA,NA,NA,NA,NA,"-","-",NA,"[-]**","0.1511")



for(i in 2:ncol(model_tab)){
  for(j in 1:nrow(model_tab)){
    # could be written if(!is.na) in other cases
    if(!is.na(model_tab[j,i])| is.numeric(model_tab[j,i])){
      model_tab[j,i] <- cell_spec(model_tab[j,i], "html", color = ifelse(grepl("[+]",model_tab[j,i]),"green", "red"))
    }
    else{
      # We have to write the "NA" in the same syntax, else kable doesnt understand why you use a syntax in some cells and not in others
      model_tab[j,i] <- paste0('<span style=" color: black;" >',model_tab[j,i],"</span>")
      # commande de tunage de couleur :<span style=" color: red;" >[ - ].</span>
    }
  }           
}


kable(model_tab,"html", escape = F) %>%  kable_styling(bootstrap_options = c("striped", "hover", "condensed","background-color :white")) %>%  add_footnote(c("NA's are non selected variables by step method","Wood trait models(BT, BD and WD) are fitted with 50 individuals","Models with Carbon and Phosphorus variables are fitted with 169 individuals", "Coefficient F -statistic ; Signif. codes:  0 '***' , 0.001 '**', 0.01 '*' ,0.05 '.', 0.1 ' ' "), notation = "alphabet")

```


```{r include=FALSE}
rm("model_tab")
```


## Which variable is the most influent ?

```{r include=FALSE}
rm("SLA_model", "LT_model", "BD_model", "LA_model", "LDMC_model","BT_model", "WD_model", "Cc_model")

rm("SLA_soil", "LT_soil", "BD_soil", "LA_soil", "LDMC_soil","BT_soil", "WD_soil", "Cc_soil")
```


The relative importance of each model variables is calculted with the unction "varimp" from caret package. A S3 method for linear model uses the absolute value of the t-statistic for each model parameter as proxy of importance. All measures of importance are scaled to have a maximum value of 100.


```{r include=FALSE}
Imp_data <- rbind(Imp_SLA, Imp_LT, Imp_BD, Imp_LA, Imp_LDMC,Imp_BT, Imp_WD, Imp_Cc)

Imp_data_soil <- rbind(Imp_SLA_soil, Imp_LT_soil, Imp_BD_soil, Imp_LA_soil, Imp_LDMC_soil,Imp_BT_soil, Imp_WD_soil, Imp_Cc_soil)

rm("Imp_SLA", "Imp_LT", "Imp_BD", "Imp_LA", "Imp_LDMC","Imp_BT", "Imp_WD", "Imp_Cc")

rm("Imp_SLA_soil", "Imp_LT_soil", "Imp_BD_soil", "Imp_LA_soil", "Imp_LDMC_soil","Imp_BT_soil", "Imp_WD_soil", "Imp_Cc_soil")
```


```{r echo=FALSE}


Imp_data  %>% mutate(Importance = as.integer(Importance)) %>% 
 ggplot(aes(x = Trait, y = Importance, fill = Variables))+
  geom_bar(stat = "identity")+
  #labs(title = "Variance component analysis", y = "fraction of the total variance explained
       #by each scale (value*100) ", x= "functional trait")+
  scale_fill_brewer(palette="Set3")+
  geom_text(aes(label = Importance, group = Variables),position = position_stack(vjust = 0.5))+
  ggtitle("Variable relative importance of each trait model 
          (non comparable data) ")

```

```{r echo=FALSE}
Imp_data_soil  %>% mutate(Importance = as.integer(Importance)) %>% 
 ggplot(aes(x = Trait, y = Importance, fill = Variables))+
  geom_bar(stat = "identity")+
  #labs(title = "Variance component analysis", y = "fraction of the total variance explained
       #by each scale (value*100) ", x= "functional trait")+
  scale_fill_brewer(palette="Set3")+
  geom_text(aes(label = Importance, group = Variables),position = position_stack(vjust = 0.5))+
  ggtitle("Variable relative importance of each trait soil model 
          (non comparable data) ")
```

