---
title: "Presentation"
author: "Emilie Ducouret"
output:
  html_document:
    highlight: pygments
    number_sections: yes
    theme: journal
    toc: yes
    toc_depth: 5
    toc_float: yes
---


```{r setup, include=FALSE}
rm(list = ls())

library(dplyr)
library(FactoMineR)
library(factoextra)
library(ggplot2)
library(ggpubr)
library(RColorBrewer)
library("gridExtra")
library("cowplot")
library(kableExtra)
library(ggrepel)

path <- "C:\\Users\\emduc\\Desktop\\Drive\\symphostage\\"

```


```{r include=FALSE}
environment_trait<- read.csv(file.path(path, "environment_trait.csv"),header = T, dec = ".", sep=",") %>% mutate(wtd = as.character(wtd), topo = as.character(topo))

environment_trait$Dawkins[which(environment_trait$ID == "15_1_198")] <- "5"

environment_trait$traitment <- NA

#┴environment_trait %>%  filter( ID == "11_4_983" |ID == "11_1_742" | ID == "2_3_236" |ID == "1_2_387" |ID == "15_1_637" |ID == "15_1_198" )

for (i in 1:nrow(environment_trait)) {
  if(environment_trait$n_parcelle[i] == "1" |environment_trait$n_parcelle[i] =="6"|environment_trait$n_parcelle[i] =="11"){
    environment_trait$traitment[i] <- "T0"
  }
  else if(environment_trait$n_parcelle[i] == "2" |environment_trait$n_parcelle[i] =="7"|environment_trait$n_parcelle[i] =="9"){
    environment_trait$traitment[i] <- "T1"
  }
  else if(environment_trait$n_parcelle[i] == "3" |environment_trait$n_parcelle[i] =="5"|environment_trait$n_parcelle[i] =="10"){
    environment_trait$traitment[i] <- "T2"
  }
  else if(environment_trait$n_parcelle[i] == "4" |environment_trait$n_parcelle[i] =="8"|environment_trait$n_parcelle[i] =="12"){
    environment_trait$traitment[i] <- "T3"
  }
  else if(environment_trait$n_parcelle[i] == "3" |environment_trait$n_parcelle[i] =="5"|environment_trait$n_parcelle[i] =="10"){
    environment_trait$traitment[i] <- "T2"
  }
  else if(environment_trait$n_parcelle[i] == "13"|environment_trait$n_parcelle[i] =="14" |environment_trait$n_parcelle[i] =="15"|environment_trait$n_parcelle[i] =="16"){
    environment_trait$traitment[i] <- "BIO"
  }
}

for (i in 1:nrow(environment_trait)) {
  if( !is.na(environment_trait$wtd[i])) {
    if (environment_trait$wtd[i] == "Watertable between 0 and 60 cm" |environment_trait$wtd[i] == "0 : accompanying water-table of the stream") {
    environment_trait$wtd[i] <- "0-60"
  }
  else if (environment_trait$wtd[i] == "Watertable deeper than 100 cm") {
    environment_trait$wtd[i] <- environment_trait$topo[i]
  }
  else if (environment_trait$wtd[i] == "Watertable between 60 and 100 cm") {
    environment_trait$wtd[i] <- "60-100"
  }
   else environment_trait$wtd[i] <- NA
   
} 
    
  }
  
rm("i")
```

Raw data set with 402 individuals, one individual (15-1-198) does not have Dawkins value because it fall down before the sampling campain. As this individual was still alive trait measures have been done and with its relative height Dawkins level 5 has been assigned.

# Functional traits
## Description 



```{r echo=FALSE}
tab = matrix(NA, ncol = 4, nrow = 8)
tab <- as.data.frame(tab)
names(tab) <- c("Trait ","Unit","Short form", "Function")

tab$`Trait ` <- c("Specific Leaf Area", "Leaf Dry Matter Content", "Leaf Thickness", "Leaf Area", "Chlorophyll content", "Branch Bark Thickness" , "Branch Bark density" , "Branch Wood density ")

tab$Unit <-c("g.cm²","g·g-1","microm","cm²", "microg.cm-²","mm","-","-")

tab$`Short form`<- c("SLA", "LDMC","LT", "LA", "Cc", "BT", "BD", "WD")

tab$Function <- c("Acquisition", "", "", "Acquisition", "Acquisiton", "Protection, stockage", "", "")

kable(tab, "html") %>%  kable_styling(bootstrap_options = c("striped", "hover", "condensed","background-color :white"))

rm(tab)
```


## Outliers 

An outlier is an observation that is numerically distant from the rest of the data. When reviewing a boxplot, an outlier is defined as a data point that is located outside the fences (“whiskers”) of the boxplot (e.g: outside 1.5 times the interquartile range above the upper quartile and below the lower quartile).

```{r message=FALSE, warning=FALSE, include=FALSE}

outliers_data <- reshape::melt(environment_trait[,c("LT", "Cc", "SLA" , "LDMC", "LA", "ID")],id=c( "ID")) %>% rename(Trait = variable, Value = value)

is_outlier <- function(x) {
  return(x < quantile(x, 0.25) - 1.5 * IQR(x) | x > quantile(x, 0.75) + 1.5 * IQR(x))
}
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
SLA <- outliers_data %>%  filter( Trait == "SLA") %>%
  filter(!is.na(Value)) %>% 
  mutate(outlier = ifelse(is_outlier(Value), as.character(ID), NA)) %>%   
  ggplot( aes(Trait, Value))+
  geom_boxplot()+
  geom_text_repel(aes(label = outlier))+
  ggtitle("SLA outliers
          with Paracou name")+
  ylab("Value (g.cm²)")

LT <- outliers_data %>%  filter( Trait == "LT") %>% 
  filter(!is.na(Value)) %>%
  mutate(outlier = ifelse(is_outlier(Value), as.character(ID), NA)) %>%   
  ggplot( aes(Trait, Value))+
  geom_boxplot()+
  geom_text_repel(aes(label = outlier))+
  ggtitle("LT outliers 
          with Paracou name")+
  ylab("Value (mm)")

LDMC <- outliers_data %>%  filter( Trait == "LDMC") %>% 
  filter(!is.na(Value)) %>%
  mutate(outlier = ifelse(is_outlier(Value), as.character(ID), NA)) %>%   
  ggplot( aes(Trait, Value))+
  geom_boxplot()+
  geom_text_repel(aes(label = outlier))+
  ggtitle("LDMC outliers
          with Paracou name")+
  ylab("Value")

outliers_data %>%  filter( Trait == "LA") %>% 
  filter(!is.na(Value)) %>%
  mutate(outlier = ifelse(is_outlier(Value), as.character(ID), NA)) %>%   
  ggplot( aes(Trait, Value))+
  geom_boxplot()+
  geom_text_repel(aes(label = outlier))+
  ggtitle("LA outliers 
          with Paracou name")+
  ylab("Value (cm²)")

Cc <-outliers_data %>%  filter( Trait == "Cc") %>%
  filter(!is.na(Value)) %>%
  mutate(outlier = ifelse(is_outlier(Value), as.character(ID), NA)) %>%   
  ggplot( aes(Trait, Value))+
  geom_boxplot()+
  geom_text_repel(aes(label = outlier))+
  ggtitle("Cc outliers  
          with Paracou name")+
  ylab("Value (microg.cm²)")

plot_grid(SLA, LT, ncol = 2, nrow = 1, align = "h")
plot_grid(LDMC, Cc, ncol= 2, nrow = 1, align = "h")

rm("SLA", "LDMC", "LT", "Cc", "outliers_data")
```

We found two outliers for SLA according to boxplot analysis. Individuals number 13-2-73 and 15-1-198 are respectively a slight  LA outliers (37.9462cm²) and a slight Dry mass outliers (0.1456g) as deviation from global distribution is really small, they can be considered as maximum range values for SLA.



We found only one outlier (15_1_637) for leaf chlorophyll content. The fifth leaf of this individual have really small mean SPAD value ( SPAD first quartile = 59.80 ; value = 28.83 ) and it negatively influence the mean SPAD value of this individual. Leaf chlorophyll content is negatively influenced by the ontogenic stage and the considered value is lower than the global distribution so is could be due to non mature leaf. Consequently, we chose to remove these outlier.
We detected seven outliers for LDMC, we only chose to remove most deviant individuals : 2_3_236 and 1_2_387 (dry weight first quartile =  0.1480 and third quartile = 0.3162 ; respective value : 0.4132g and 0.0874g ). 
Finally, we detected 18 outliers for leaf area corresponding to natural variation (i.e. young individuals can have big leaves). 


```{r include=FALSE}

environment_trait$LDMC[which(environment_trait$ID == "2_3_236" |environment_trait$ID == "1_2_387")] <- NA

environment_trait$Cc[which(environment_trait$ID == "15_1_637")] <- NA

environment_trait %>%  filter(ID == "11_1_742"  | ID == "11_4_983" | ID == "2_3_236"| ID == "1_2_387" | ID == "15_1_637")
```

## trait distribution 


```{r trait distribution, echo=FALSE, message=FALSE, warning=FALSE}

SLA <- ggplot(environment_trait, aes(SLA))+
  geom_histogram()

LDMC <- ggplot(environment_trait, aes(LDMC))+
  geom_histogram()
LT <- ggplot(environment_trait, aes(LT))+
  geom_histogram()
Chloro <- ggplot(environment_trait, aes(Cc))+
  geom_histogram()
Area <- ggplot(environment_trait, aes(LA))+
  geom_histogram()
 Area.log <- ggplot(environment_trait, aes(log10(LA)))+
  geom_histogram()

plot_grid(SLA, LDMC, LT, Chloro, Area ,Area.log , ncol = 2, nrow = 3)

rm("SLA", "LDMC", "LT", "Chloro", "Area")
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
BT <- ggplot(environment_trait, aes(BT))+
  geom_histogram()
BD <- ggplot(environment_trait, aes(BD))+
  geom_histogram()
WD<- ggplot(environment_trait, aes(WD))+
  geom_histogram()

plot_grid(BT, BD, WD, ncol = 2, nrow = 2)

rm("BT", "BD", "WD")
```

# Environmental variables
## Description 

```{r echo=FALSE}
tab2 = matrix(NA, ncol = 6, nrow = 13)
tab2 <- as.data.frame(tab2)
names(tab2) <- c("Variable","Unit","Short form", "Description", "Category", "Comment")

tab2$Variable <- c("Distance to the nearest creek"  ,"Digital Elevation Model", "Slope" ,"Curvature" ,"Topographic Ruggedness Index","Topographic Wetness Index","Relative altitude to the nearest creek" ,"Distance to the nearest canopy gap"
 ,"Soil Carbon concentration" ,"Soil Phosphorus concentration" , "Dawkins", "Diameter at breast Height","Local Basal Area  (Steneker and Jarvis 1963) ")

tab2$Unit <-c("meter","meter","-","-", "-", "-","meter", "meter","meter", "","-", "cm","m²")

tab2$`Short form`<- c("d_creek", "DEM","Slope", "Curvature", "TRI", "TWI", "alt_creek", "d_gap",  "C", "P", "Dawkins", "Diameter","lBAL")

tab2$Category <- c(rep("Abiotic",10), rep("Biotic", 3))

tab2[9:10,6] <- c(rep("only for 169 individuals",2))

#tab2[13,6] <- c("$$lBAL \equiv \sum_{j\equiv1}^nBA_j ,\ where\ i\ \ne j$$")

tab2$Description <- c("Water avalaibility", "Altitude, Nutrients avalaibility, Dryness","Nutrients avalaibility", "","", "Water avalaibility","Water avalaibility, Dryness", "Light avalaibility from treefall gap","Nutrient avalaibility","soil fertility", "Canopy light exposition", "Ontogenic stage","Neighors competition index for light, nutrients and water")

kable(tab2, "html") %>%  kable_styling(bootstrap_options = c("striped", "hover", "condensed","background-color :white")) 

rm(tab2)
```

Interaction between diameter and different environmental variables will be added in the additive linaer model given that neighbors competition impact (lBAL) is modulated by diameter of the focal tree. As an hight tree which already reech the canopy would be less affect by crowding and shadowing neighbors effect. Moreover diameter also interact with d_gap because bigger tree could benefit more from gap light than a smaller one close to the same gap. This is the same idea for bottom land (wetness value  between 1.395 and 8.010 according to topographic category from F.Morneau (2007)) and diameter because bottom land area in guyanian tropical rain forest are known to be more biologically dynamic which means stand renewal is faster due more frequent tree fall which induce more light gap. An other particularity of bottom land is that the mean canopy height is lower than other areas like slope and hilltop (voir cours stéphane B.ferry ?), so wetness maybe modulate positively light availability.

The only variable that depict ontogenic stage is the diameter at breast height (DBH). For every tree sapling and early ontogenic stage individual are in the underlayer of canopy and as we know light availability decrease from canopy to the ground. Irradiance is a very heterogeneous resource, and can be as high as 47 mol m−2 day−1 above the canopy and as low as 0·15 mol m−2 day−1 at the forest floor (Chazdon 1988). Thus functional response of younger tree to the environment would be different from older individual in different light condition. For example younger individual would have higher SLA value to maximise light interceptection and so their growth to reech the canopy layer.
Consequently diameter would modulate SLA value and other light modulated traits.  

## Covariation 

```{r environment standar, include=FALSE}
environment_standar <- environment_trait %>% 
  dplyr::select(n_parcelle, n_carre, n_arbre, Dawkins, Carbon , Phosphorus ,  lBAL,wetness,   d_creek,dem,slope, d_gap, alt_creek, TRI, curvature) %>% 
  mutate(alt_creek = as.numeric(alt_creek), Dawkins = as.factor(Dawkins))  

environment_standar[,7:15] <- as.data.frame(scale(as.matrix(environment_standar[,7:15]),scale = TRUE, center = TRUE)) 

```


```{r echo=FALSE}
acp_envi <- PCA(environment_standar[,7:14], graph =  FALSE)
fviz_pca_var (acp_envi , axes = c(1, 2), scaling =2, col.var = "contrib")
fviz_screeplot(acp_envi, ncp=10)
```

63.1% of the total inertia is explained by the first factorial plan. Selected environmental variable are wetness and lBAL  as they are well represneted and less correlated variables in this dataset .

TRI, is highly coreelate to dem, slope because the only source of topographic heterogeneoty in guianean relief is hill slope and half-orange relief are hight redundant in guianean landscape. 

```{r include=FALSE}
panel.cor <- function(x, y, digits=2, prefix="", cex.cor) {
  usr <- par("usr")
  on.exit(par(usr))
  par(usr = c(0, 1, 0, 1))
  r <- abs(cor(x, y, use = "complete.obs", method = "spearman"))
  txt <- format(c(r, 0.123456789), digits = digits)[1]
  txt <- paste(prefix, txt, sep = "")
  if (missing(cex.cor)) cex <- 0.7 / strwidth(txt)

  test <- cor.test(x, y)
  # borrowed from printCoefmat
  Signif <- symnum(
    test$p.value, corr = FALSE, na = FALSE,
    cutpoints = c(0, 0.05, 0.1, 1),
    symbols = c("*", ".", " ")
  )

  text(0.5, 0.5, txt, cex = cex/2)
  text(.8, .8, Signif, cex = cex, col = 2)
}
```

```{r}
pairs(environment_standar[,c("wetness","d_gap","lBAL")], lower.panel = panel.smooth, upper.panel = panel.cor)
```

### adding soil data (C, P)

This subset (169 individuals) of the main data set brings information about carbon and phosphorus soil concentration at the sampled individual place (mean). Soil element concentration  come from Allié *et al,* 2015 and are only availaible for plot number 1-6-11-13-14-15. 


```{r echo=FALSE}
envi_soil <- environment_standar %>%  filter(!is.na(Carbon))
acp_soil <- PCA( envi_soil[,c("lBAL", "wetness", "Carbon", "Phosphorus", "curvature", "d_gap")], graph =  FALSE)
fviz_pca_var (acp_soil , axes = c(1, 2), label ="var", scaling =2, col.var = "contrib")
fviz_screeplot(acp_soil, ncp=10)

```

65.1% of the total inertia is explain by he first factorial plan so others will be not show or look here. Phosphore is  positively correlated to wetness whereas Carbon soil concentration is negatively correlated to wetness.  It means that Phosphor concentration are higher in dryer area (i e hilltop and slope) whereas Carbon is value are higher in wetter area (i e bottomland). 

```{r echo=FALSE}
pairs(envi_soil[,c("wetness","Carbon","Phosphorus","lBAL")], lower.panel = panel.smooth, upper.panel = panel.cor)
```
As correlation coefficient (Spearman method do no assumption of normality)between these desecriptor is low which limited redundant information, we choose to keep them all as modelling variables. 


### Dawkins 

Dawkins variables is factorial (five different levels) and represent canopy light exposure. Tropical rain forest are verticuly structured , different layer can be depicted by their light avalaibility.The darkest one is sapling layer and canopy is the lighter. Thus for a given individual light exposure denpends on its height and diameter. 

```{r echo=FALSE}
ggplot(environment_trait, aes(Dawkins, diameter, fill = Dawkins))+
  geom_boxplot()+
    stat_compare_means(method = "anova", 
                     label.y = 90, label.x = 2) +
  stat_compare_means(method = "t.test", 
                     aes(label = ..p.signif..),
                     ref.group = ".all.",
                     label.y = 85)+
  geom_hline(yintercept = mean(environment_trait$diameter), linetype = 2)+
  ggtitle("Class diameter distribution in Dawkins levels")+
  scale_fill_brewer(palette="PiYG")
```
```{r include=FALSE}
TukeyHSD(aov(lm(diameter~Dawkins, data = environment_trait)))
```

Here each Dawkins levels correspond to a significant different diameter class (t.test result with ref.group ".all."). Tukey HSD test result is significant for every pairs group which mean every category have mean diameter significantly different from each others. We select diamter as a modelling variable because it is continus and could interact with others parameter (see below : wetness, lBAL).

# How does functional traits covariate at the intra-specific scale ? 
## Leaf functional traits


```{r trait standar, include=FALSE}
trait_standar <- environment_trait %>%
  dplyr::select(n_parcelle, n_carre, n_arbre,LT, Cc, LDMC, SLA, LA) 

trait_standar[,4:8] <- as.data.frame(scale(as.matrix(trait_standar[,4:8]), center = TRUE, scale = TRUE))
```
  
```{r echo=FALSE, message=FALSE, warning=FALSE}
trait.pca <- PCA(trait_standar[,4:8], graph = F)
fviz_pca_biplot(trait.pca , axes = c(1, 2), label ="var", scaling =2, col.var="contrib", col.ind="grey")
fviz_screeplot(trait.pca, ncp=10)
```

Projection of the first and second axis explain 76.3% of the total inertia, only the first factorial plan is retained. PCA is realized with 401 observations and standardized data (z-score method) but  results does not change with raw data. Chlorophyll content and LDMC are highly correlated and both are negatively correlated to Leaf area.  SLA and Leaf thickness are opposed , weakly correlated to the other variables. 




## Leaf and Wood functional trait 

```{r include=FALSE}
bois <- environment_trait %>%  filter(!is.na(BT)) %>%  dplyr::select(-Branch_diameter)

bois[,8:15] <- as.data.frame(scale(as.matrix(bois[,8:15]), center = TRUE, scale = TRUE))
```

```{r echo=FALSE}
trait_bois_pca <- PCA(bois[,8:15], graph = F)
fviz_pca_biplot(trait_bois_pca, axes = c(1, 2), label ="var", scaling =2, col.var = "contrib", col.ind="grey")
fviz_screeplot(trait_bois_pca, ncp=10)
```

Projection of the first and second axis explain 60.2% of the total inertia, only the first factorial plan is retained. PCA is realized with 50 observations and standardized data (z-score method), results does not change with raw data.  We can see that relation between leaf functional trait stay  identical. Then smaller individuals headcount does not influence functional trait relation in this functional trait correlation analysis.

## Is trait covariation pattern modifed at local topographic scale ?


```{r trait topo, include=FALSE}
trait_topo <- environment_trait %>% 
  dplyr::select(topo, LT, Cc, LDMC, SLA, LA, wtd) %>% filter(!is.na(SLA)) %>% filter(!is.na(LDMC)) %>% filter(!is.na(Cc)) %>%  filter(!is.na(topo)) 

trait_topo[,2:6] <- as.data.frame(scale(as.matrix(trait_topo[,2:6]), center = TRUE, scale = TRUE))

```
 
 
```{r covartopo, echo=FALSE, message=FALSE, warning=FALSE}

trait_60 <- trait_topo %>%   filter(wtd =="0-60")

trait_P <- trait_topo %>%   filter(wtd== "Pente")

trait_Pl <- trait_topo %>%   filter(wtd== "Plateau")

trait_100 <- trait_topo %>%  filter(wtd== "60-100")

#trait_P100 <- trait_topo %>%  filter(wtd== "100")

BF_100 <-fviz_pca_var(PCA(trait_100[,2:6], graph = F) , axes = c(1, 2), label ="var", scaling =2, col.var="contrib", col.ind="grey")+
  labs(title ="Trait covariation in watertable 60-100")
BF_60 <- fviz_pca_var(PCA(trait_60[,2:6], graph = F) , axes = c(1, 2), label ="var", scaling =2, col.var="contrib", col.ind="grey")+
  labs(title ="Trait covariation in watertable 0-60")
P<- fviz_pca_var(PCA(trait_P[,2:6], graph = F) , axes = c(1, 2), label ="var", scaling =2, col.var="contrib", col.ind="grey")+
  labs(title ="Trait covariation in slope ")
Pl <-fviz_pca_var(PCA(trait_Pl[,2:6], graph = F) , axes = c(1, 2), label ="var", scaling =2, col.var="contrib", col.ind="grey")+
   labs(title ="Trait covariation in hilltop ")

plot_grid(BF_60, BF_100, P ,Pl, ncol = 2, nrow = 2)

rm("trait_100", "trait_P", "trait_Pl", "trait_60", "BF_100", "P", "Pl", "BF_60")

```

Bottomland with  watertable between 0-60cm : 137 individuals
Bottomland with  watertable between 60-100cm : 34 individuals
pente : 141 individuals
plateau : 83 individuals

```{r covartopobois, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
bois <- environment_trait %>%  filter(!is.na(BT)) %>%  dplyr::select(-Branch_diameter)
bois[,12:19] <- as.data.frame(scale(as.matrix(bois[,12:19]), center = TRUE, scale = TRUE))

trait_60 <- bois %>%   filter(wtd =="0-60")

trait_P <- bois %>%   filter(topo== "Pente")

trait_Pl <- bois %>%   filter(topo== "Plateau") 

trait_100 <- bois %>%  filter(wtd== "60-100")


P_Pl <-fviz_pca_var(PCA(trait_100[,12:19], graph = F) , axes = c(1, 2), label ="var", scaling =2, col.var="contrib", col.ind="grey")+
  labs(title ="Trait covariation in watertable 60-100")
BF <- fviz_pca_var(PCA(trait_60[,12:19], graph = F) , axes = c(1, 2), label ="var", scaling =2, col.var="contrib", col.ind="grey")+
  labs(title ="Trait covariation in watertable 0-60")
P<- fviz_pca_var(PCA(trait_P[,12:19], graph = F) , axes = c(1, 2), label ="var", scaling =2, col.var="contrib", col.ind="grey")+
  labs(title ="Trait covariation in slope ")
Pl <-fviz_pca_var(PCA(trait_Pl[,12:19], graph = F) , axes = c(1, 2), label ="var", scaling =2, col.var="contrib", col.ind="grey")+
  labs(title ="Trait covariation in hilltop ")

plot_grid(P_Pl, BF, P, Pl , ncol = 2, nrow = 2)

#rm("trait_test", "trait_P", "trait_Pl", "trait_BF", "P_Pl", "BF", "P", "Pl")
```
0-60 20
60-100 6 
Slope 15 individuals
Hilltop 8 individuals

# Is intraspecific trait variability equal for every functional trait ?

The most simple way to calculate the intraspecific variability of a functional trait is the coefficient of variation (in %) (Messier *et al,* 2016 ; Fajardo and Piper 2011;  Jung *et al,* 2010). It is an dimensionless value that allowed to compare the range of value for each functional trait.  Coefficient of variation is calculated on raw data with any standardisation or transformation (as it could be log10 transformed for Leaf area) 

```{r include=FALSE}
CV <- function(mean, sd){
      (sd/mean)*100
      }
```


```{r echo=FALSE}
mean_data <- environment_trait %>% 
  dplyr::select( SLA, LDMC, LT, Cc, LA) %>% 
   summarize_at(c("SLA", "LDMC", "LT", "Cc", "LA"), mean, na.rm = T)

sd_data <- environment_trait %>% 
  dplyr::select( SLA, LDMC, LT, Cc, LA) %>% 
   summarize_at(c("SLA", "LDMC", "LT", "Cc", "LA"), sd, na.rm = T)

CV_data <- CV(mean = mean_data , sd= sd_data) 

CV_data[1,6] <- "Coeffcient of variation"

CV_data <- CV_data[, c("V6", "SLA", "LDMC", "LT", "LA", "Cc")] %>% rename(" "=V6)

CV_data %>%   kable("html") %>% kable_styling()

rm("CV", "sd_data", "mean_data","CV_data")
```

The total variation differs between traits : Leaf area is the most variable trait with 56% of variation followed by SLA (46.6%). Then Leaf thickness (27.6%) and Chlorophyll content (15.6%) are two or three time less variable than  SLA and Leaf area. Finally the least variable functional trait is LDMC with only 11.7%.

As different diameter classes have been sampled does it means that LDMC is a more conservative trait through ontogenic stage whereas SLA and Leaf area are highly variable ?


# How variance is partionned between sampling scales ?

## Variance partitionning analysis 


Variance component analysis gives the amount of variation that can be attributed to each different factor that can be used to defined an observation because random factor levels are chosen at random from a large or infinite set of levels,  variance could be attribute to choice of factor we have made. In our case several factor can be taking into account : where it have been sampled (plot number), which morphotype it is (here bark morphotype from field campagne data)  , which individual , which leaf of this individual is considered. The last factor is nested into the individual strata. 
The linear mixed model is designed to introduce random effect in the formula. The formula used for the variance component analysis is the following one based on Messier *et al* (2010)  for each studied functional trait (SLA, LDMC, LT ,LA and Cc) , four strata has been defined plot (Paracou parcelle) morphotype type (Globulifera, hybrid or Sp.1), individual and leaves (5 samples for each tree except for 5 individuals). Result of varcomp function show the fraction of variance explained by each strata plus an additive strata (automatically named “Within”, Venables and Ripley, 2002) of the component of variance with the studied variable (Solomon 2005) plus the model error. 

```{r eval=FALSE}
varcomp.SLA<-varcomp(lme(SLA~1,random=~1|n_parcelle/morphotype_field/n_arbre/n_feuille, data = varcomp_data ,na.action = na.omit),1)
```



```{r message=FALSE, warning=FALSE, include=FALSE}
library(ape)
library(nlme)

varcomp_data <- read.csv(file.path(path, "varcomp_data.csv"),header = T, dec = ".", sep=",") %>% 
filter(!(LDMC < 0.17 |LDMC > 0.55)) %>% 
 filter(! Cc < 40.5) 

varcomp_data[,9:13] <- as.data.frame(scale(as.matrix(varcomp_data[,9:13]), center = TRUE, scale = TRUE))

varcomp_data %>% 
  mutate(ID = as.factor(paste(n_parcelle, n_carre, n_arbre, sep="_"))) %>%  dplyr::select(ID,n_feuille,LA) %>%
  filter(ID == "11_4_983")
```


```{r include=FALSE}
varcomp.SLA2<-varcomp(lme(SLA~1,
random=~1|n_parcelle/topo/morphotype_field/n_arbre/n_feuille, data = varcomp_data ,na.action = na.omit),1)
```

```{r varcomp lmdc 2, include=FALSE}
varcomp.LDMC2<-varcomp(lme(LDMC~1,
random=~1|n_parcelle/topo/morphotype_field/n_arbre/n_feuille, data = varcomp_data ,na.action = na.omit),1)
```

```{r include=FALSE}
varcomp.LT2<-varcomp(lme(LT~1,
random=~1|n_parcelle/topo/morphotype_field/n_arbre/n_feuille, data = varcomp_data ,na.action = na.omit),1)
```


```{r include=FALSE}
varcomp.Area2<-varcomp(lme(LA~1,
random=~1|n_parcelle/topo/morphotype_field/n_arbre/n_feuille, data = varcomp_data ,na.action = na.omit),1)
```

```{r include=FALSE}
varcomp.Chloro2<-varcomp(lme(Cc~1,
random=~1|n_parcelle/topo/morphotype_field/n_arbre/n_feuille, data = varcomp_data ,na.action = na.omit),1)
```


```{r include=FALSE}

varcomp_resu2 <- as.data.frame(cbind(varcomp.Area2, varcomp.LDMC2, varcomp.LT2, varcomp.SLA2, varcomp.Chloro2))

  varcomp_resu2 <- varcomp_resu2 %>% mutate( niveau = rownames(varcomp_resu2)) %>% 
    dplyr::rename(LA = "varcomp.Area2", LT="varcomp.LT2", LDMC = "varcomp.LDMC2", SLA = "varcomp.SLA2", Cc= "varcomp.Chloro2") 
  
varcomp_resu2$niveau <- factor(varcomp_resu2$niveau, levels = varcomp_resu2$niveau)    

varcomp_resu2 <- reshape::melt(varcomp_resu2,  id=c("niveau")) %>% 
  mutate(value1 = as.integer(value*100)) %>%  
  mutate(niveau = as.factor(niveau))
  
rm("varcomp.Chloro2", "varcomp.SLA2", "varcomp.LDMC2", "varcomp.LT2", "varcomp.Area2")
```


```{r varcomp SLA, include=FALSE}
varcomp.SLA<-varcomp(lme(SLA~1,
random=~1|n_parcelle/morphotype_field/n_arbre/n_feuille, data = varcomp_data ,na.action = na.omit),1)
```

```{r varcomp LMDC, include=FALSE}
varcomp.LDMC<-varcomp(lme(LDMC~1,
random=~1|n_parcelle/morphotype_field/n_arbre/n_feuille, data = varcomp_data ,na.action = na.omit),1)
```

```{r varcomp LT, include=FALSE}
varcomp.LT<-varcomp(lme(LT~1,
random=~1|n_parcelle/morphotype_field/n_arbre/n_feuille, data = varcomp_data ,na.action = na.omit),1)
```


```{r varcomp Area, include=FALSE}
varcomp.Area<-varcomp(lme(LA~1,
random=~1|n_parcelle/morphotype_field/n_arbre/n_feuille, data = varcomp_data ,na.action = na.omit),1)
```

```{r varcomp chloro, include=FALSE}
varcomp.Chloro<-varcomp(lme(Cc~1,
random=~1|n_parcelle/morphotype_field/n_arbre/n_feuille, data = varcomp_data ,na.action = na.omit),1)
```


```{r varcomp resu, include=FALSE}

varcomp_resu <- as.data.frame(cbind(varcomp.Area, varcomp.LDMC, varcomp.LT, varcomp.SLA, varcomp.Chloro))

  varcomp_resu <- varcomp_resu %>% mutate( niveau = rownames(varcomp_resu)) %>% 
    dplyr::rename(Area = "varcomp.Area", LT="varcomp.LT", LDMC = "varcomp.LDMC", SLA = "varcomp.SLA", Chloro = "varcomp.Chloro")
  
varcomp_resu$niveau <- factor(varcomp_resu$niveau, levels = varcomp_resu$niveau)    

varcomp_resu <- reshape::melt(varcomp_resu,  id=c("niveau")) %>% 
  mutate(value1 = as.integer(value*100)) %>% 
  mutate(niveau = as.factor(niveau))

rm("varcomp.Chloro", "varcomp.SLA", "varcomp.LDMC", "varcomp.LT", "varcomp.Area2")
```


```{r varcomp plot, echo=FALSE}
ggplot(varcomp_resu,aes(x = variable, y = value1, fill = niveau, order= niveau))+
  geom_bar(stat = "identity", position = "stack")+
  labs(title = "Variance component analysis", y = "fraction of the total variance explained
       by each scale (value*100) ", x= "functional trait")+
  scale_fill_brewer(palette="PiYG")+
  geom_text(aes(label = value1, group = niveau),position = position_stack(vjust = 0.5))
```

```{r echo=FALSE}
 ggplot(varcomp_resu2,aes(x = variable, y = value1, fill = niveau, order= niveau))+
  geom_bar(stat = "identity", position = "stack")+
  labs(title = "Variance component analysis", y = "fraction of the total variance explained
       by each scale (value*100) ", x= "functional trait")+
  scale_fill_brewer(palette="PiYG")+
  geom_text(aes(label = value1, group = niveau),position = position_stack(vjust = 0.5))
```

Without topo : 

The individual level is the major source of variance (53 to 81% of the total variance) in the trait distribution, except for leaf thickness (41%)  for which plot  (39%) also highly contribute to variance. Chlorophyll content and LDMC have bigger internal variance fraction than other traits (respectively 40% and 29%). Morphotype strata  contribute the most to  Leaf area  variance with 29% of the total variance.  Finally leaf strata does not contribute at all in any functional trait variance. 
With topo : 
As we can test the parcelle random effect , we can also add an topographic strata random effect to see if some variance can be allocated to the topographic localisation of the sampled individual. Also morphotype categories are correlated to topographic variation but not totally (see bellow) so adding topographic scale would depict variance truly due to morphotype categories. As we can see topographic level replace morphotype variance fraction for Leaf Area, LDMC and Chlorophyll content but not Leaf thickness. Moreover leaf level of variance is now visible (3% and 6%)  and replace a fraction of the within level (random error of the linear mixed model) for Leaf thickness and Specific leaf area  and for the other level nothing change. 

As we have 6 different scales we can associate each one to an environmental source of variation. Plot and topographic level would be associated to environmental filtering and individual, morphotype and leaf to plasticity as it has been defined in Messier *et al,* (2016).

## Why Leaf thickness is influenced by plot levels ?



```{r include=FALSE}
rain <- read.csv(file.path(path, "Donnes_tour_a_flux.csv"),header = T, dec = ",", sep=";") %>% dplyr::select(Ann.e, Mois, jour, Pluie) %>%  
  filter(Mois =="Novembre" | Mois == "Decembre" | Mois == "Octobre")

environment_trait <- environment_trait %>%  mutate(n_parcelle = as.factor(n_parcelle))
```



```{r pluie-date, include=FALSE}
rain <- rain %>%  group_by(Ann.e, Mois,  jour) %>% summarize_at(c( "Pluie") , mean, na.rm = T)

rain_novembre <- rain %>%  filter((Mois == "Novembre")) %>% 
  mutate(jour2 = row.names(.)) %>% 
  mutate(mois2 = 11)

rain_december <- rain %>%  filter((Mois == "Decembre")) %>% 
  mutate(jour2 = row.names(.))%>% 
  mutate(mois2 = 12)

rain_october <- rain %>%  filter((Mois == "Octobre")) %>% 
  mutate(jour2 = row.names(.))%>% 
  mutate(mois2 = 10)

rain_date <- full_join(rain_december,rain_novembre, by = c("Ann.e", "Mois", "jour", "Pluie", "jour2", "mois2"))  
```


```{r include=FALSE}
rain_date <- full_join(rain_date,rain_october, by = c("Ann.e", "Mois", "jour", "Pluie", "jour2", "mois2"))  %>% 
  mutate(jour2 = as.numeric(jour2)) %>% 
  mutate(Date = ifelse((jour2 < 10),  paste(paste(0,jour2, sep=""), mois2, Ann.e, sep="/"), paste(jour2, mois2, Ann.e, sep="/")))

rm("rain_december","rain_novembre" , "rain", "rain_october")
```


```{r trait-date, include=FALSE}

Measures_Individuals2 <- read.csv(file.path(path, "Measures - Individuals.csv"),header = T, dec = ".", sep=",") %>% 
  dplyr::rename( n_parcelle = "Plot" , n_carre = "Subplot" , n_arbre = "Tree") %>% 
  mutate(n_parcelle = as.factor(n_parcelle))

data <- left_join(environment_trait, Measures_Individuals2, by = c("n_parcelle" , "n_carre" , "n_arbre")) %>% 
  mutate( n_parcelle = as.factor(n_parcelle)) %>% 
  dplyr::select(n_parcelle, n_carre, n_arbre, LT , Cc ,SLA , LDMC, LA, Date)

```


```{r include=FALSE}
rain_date$rain_cumul <- NA

rain_date <- rain_date %>%  arrange(mois2, jour2)

rain_date[1,c("rain_cumul")] <- rain_date[1,c("Pluie")]

for (i in 2:nrow(rain_date)) {
  rain_date$rain_cumul[i] <- rain_date$Pluie[i]+ rain_date$rain_cumul[i-1]
  
}
```


```{r combine trait-rain, include=FALSE}
data_rain <- left_join(data, rain_date, by="Date") %>% 
  mutate(n_parcelle = as.factor(n_parcelle))

environment_trait <- data_rain %>%  dplyr::select(n_parcelle, n_carre, n_arbre, jour) %>%  inner_join(environment_trait, by = c("n_parcelle", "n_carre", "n_arbre"))
```

Paracou station is divided in 16 plots that correspond to an  experimental design for forest disturbance by selective logging experiment released in 1984. So plot can be group by traitement that respectively correspond to : control plot (T0), selective logging (T1) , selective logging and timber stand improvement(TSI)  (T2), selective logging + TSI + fuelwood (T3). Later (1990-1992) three new undisturbed plot have been added to the domain as “biodiversity” plot. As leaf thickness is highly influence by plot strata (in the linear mixed model) we can test if disturbance traitement is the source of difference between plot. 

```{r echo=FALSE}
environment_trait %>%  mutate( n_parcelle = as.factor(n_parcelle)) %>%
  ggplot( aes(n_parcelle,LT, fill = traitment))+
  geom_boxplot()+
    stat_compare_means(method = "anova", 
                     label.y = 525, label.x = 2) +
  stat_compare_means(method = "t.test", 
                     aes(label = ..p.signif..),
                     ref.group = ".all.",
                     label.y = 505)+
  geom_hline(yintercept = mean(environment_trait$LT), linetype = 2)+
  ggtitle("Leaf thickness distribution in each plot")
```



```{r echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(scales)
data %>% 
  select(Date, n_parcelle, LT, SLA, LDMC, Cc, LA) %>% 
  mutate( n_parcelle = as.factor(n_parcelle)) %>% 
  reshape2::melt(id = c("Date", "n_parcelle"), variable.name = "Trait") %>% 
  ggplot(aes(as.Date(Date, format = "%d/%m/%Y"), value, col = n_parcelle)) +
  geom_point() +
  scale_x_date(labels = date_format("%b")) +
  facet_wrap(~Trait, scales = "free")
```



```{r echo=FALSE}
data2<- data %>%  group_by(Date, n_parcelle) %>%  summarize_at(c( "LT") , mean, na.rm = T)

ggplot(data2, aes(as.Date(data2$Date, format = "%d/%m/%Y"), LT, col = n_parcelle)) + 
geom_point() +
  geom_text_repel(aes(label = data2$n_parcelle))
```


```{r echo=FALSE}

data_rain3 <- data_rain %>%  group_by(Date, n_parcelle,rain_cumul) %>%  summarise() 

ggplot(data_rain3,aes(as.Date(data_rain3$Date, format = "%d/%m/%Y"),rain_cumul, color = n_parcelle )) + 
geom_point()+
  geom_text_repel(aes(label = data_rain3$n_parcelle))
```

Daily rain data from Guyaflux tour in function sampling date. We can see that there is an increased rainfall tendency that starts at the beginning of december (01/12/17) with plot number seven. It matches with the beginning of the leaf thickness decreasing tendency.   However rainfall does not increase constantly, the following days have lower daily rain value 06/12, 07/12 (plot 16 sampling date) 14/12 (half of plot 12 and 10)  and 18/12 (plot 6).  But rainfall quantity over days can be considered as cumulative due to ecosystem latency period to incorporate the incoming water. So water availability in the studied ecosystem starts increasing in the beginning of december which correspond to the decrease of leaf thickness. However such tendency under tropical latitude do not have been reported in the litterature. Gotsh et al (2010) did not found significant seasonal decrease between dry and wet season for leaf thickness at the intraspecific level. Moreover, at larger scale  leaf thickness increase along annual rainfall gradient (Santiago, 2003). But at worldwide biome scale it is well known, that species in dryer areas have thicker leaves than other one (Maximov, 1929; Mooney et al., 1978;Specht & Specht, 1989; Schulze et al., 1998; Cunningham et al., 1999; Niinemets, 2001, Wright and Westoby, 2002)

```{r echo=FALSE}


data_rain %>%  group_by(n_parcelle,Date) %>%  summarize_at(c( "LT", "rain_cumul") , mean, na.rm = T) %>% mutate( Date = as.Date(Date, format = "%d/%m/%Y")) %>% 
  ggplot(aes(LT,rain_cumul, color= Date))+
  geom_point()+
  geom_text_repel(aes(label = n_parcelle))
  
  
```



```{r echo=FALSE}
ggplot(environment_trait, aes((n_parcelle),(diameter) ))+
  geom_boxplot()+
stat_compare_means(method = "anova", 
                     label.y = 90, label.x = 2) +
  stat_compare_means(method = "t.test", 
                     aes(label = ..p.signif..),
                     ref.group = ".all.",
                     label.y = 85)+
  geom_hline(yintercept = mean(environment_trait$diameter), linetype = 2)
```


```{r echo=FALSE}
ggplot(environment_trait, aes(diameter, LT, color = Dawkins ))+
  geom_point()
```

```{r echo=FALSE}
LT_model <-lm(LT~diameter, data= environment_trait)
summary(LT_model)
par(mfrow = c(2,2))
plot(LT_model)
```

#  How envrionmental variables influence functional trait distribution ? 

```{r include=FALSE}
environment_trait <- environment_trait %>% mutate(LA = log10(LA))
```


```{r include=FALSE}
#need to add "jour" from data_rain ! 
environment_trait$LDMC[which(environment_trait$ID == "2_3_236" |environment_trait$ID == "1_2_387")] <- NA

environment_trait$Cc[which(environment_trait$ID == "15_1_637")] <- NA


data_standar<- environment_trait %>% 
  dplyr::select(n_parcelle, n_carre, n_arbre,morphotype_field, jour,diameter,  lBAL, wetness, d_gap, Carbon, Phosphorus, SLA, LA, LT, LDMC, Cc, BT, BD, WD) %>% 
  mutate(n_parcelle = as.factor(n_parcelle) ,LA = log10(LA))

data_standar [,6:19]<- as.data.frame(scale(as.matrix(data_standar[,6:19]),scale = TRUE, center = TRUE)) 

envi_soil <-  environment_trait %>%  filter(!is.na(Carbon)) %>% 
  dplyr::select(n_parcelle, Dawkins, jour, diameter, Carbon, Phosphorus ,wetness,lBAL, d_gap, alt_creek ,SLA , LT, Cc, LA, LDMC, BT, BD, WD) 

envi_soil[,4:17] <- as.data.frame(scale(as.matrix(envi_soil[,4:17]),scale = TRUE, center = TRUE))
```
Standardized data and LA log10 transformed

##  Multi trait linear analysis : RDA

### Leaf traits


```{r message=FALSE, warning=FALSE, , message=FALSE, include=FALSE}
library(ade4)
library(vegan)
library(MASS)
library(ellipse)

```

```{r include=FALSE}
trait_center <- environment_trait %>%
  dplyr::select(LT, Cc, LDMC, SLA, LA) %>%
  filter(!is.na(SLA)) %>% 
   filter(!is.na(Cc)) %>% 
   filter(!is.na(LDMC))

trait_center <- as.data.frame(scale(as.matrix(trait_center), center = TRUE, scale =  FALSE))

data_standar <- data_standar %>% filter(!is.na(SLA)) %>% 
   filter(!is.na(Cc)) %>% 
   filter(!is.na(LDMC))
```

```{r include=FALSE}
rda_trait <- rda(trait_center,data_standar[,6:8],scale = T, na.omit= T)

```

Accumulated constrained eigenvalues
Importance of components:Proportion Explained for RDA1 and RDA2 correspond to explained percentage on graph
```{r echo=FALSE}
library(ggvegan)
library(ggord)

# ggord(rda_trait,grp_in =  data_standar$morphotype ,ptslab = TRUE, addsize = 5, parse = TRUE, repel = TRUE, coord_fix = TRUE, veclsz = 1) 
source("C:/Users/emduc/Desktop/symphostage/ninoplot.R")  

rda_trait %>% ninoplot(arrows = TRUE,layers = c("species", "sites", "biplot", "centroids"), palettage = TRUE,mypal = "Accent", quali_sup = data_standar$morphotype_field)#add argument    

# autoplot(rda_trait, arrows = TRUE, legend = "none",layers = c("species", "sites", "biplot", "centroids"))

```

### Wood traits 



```{r include=FALSE}
trait_center2 <- environment_trait %>%
  filter(!is.na(BT)) %>% 
  dplyr::select( BT, BD, WD, Cc, LDMC, SLA, LT)
 

trait_center2 <- as.data.frame(scale(as.matrix(trait_center2), center = TRUE, scale =  FALSE))

envi_rda <- environment_trait %>% 
  dplyr::select( diameter,lBAL,wetness, BT, Cc, LDMC, SLA, morphotype_field) %>% 
  filter(!is.na(BT)) %>% 
  filter(!is.na(SLA)) %>% 
  filter(!is.na(Cc)) %>% 
  filter(!is.na(LDMC))

envi_rda[,1:7] <- as.data.frame(scale(as.matrix(envi_rda[,1:7]),scale = TRUE, center = TRUE)) 
```

```{r include=FALSE}
rda_trait2 <- rda(trait_center2,envi_rda[,c("wetness","lBAL", "diameter")],scale = T, na.omit= T)
```

```{r echo=FALSE}
rda_trait2 %>% ninoplot(arrows = TRUE,layers = c("species", "sites", "biplot", "centroids"), palettage = TRUE,mypal = "Accent",quali_sup = envi_rda$morphotype_field)
```

##  Univariate analysis : linear model

Functional traits and environmental variables are standardized by z-score method. Interaction between focal tree diameter and sum of  the local basal area (lBAL) is added to the following model as neighbor competition effect is vary according to the focal tree diameter. 

### SLA model 
#### general environment

```{r SLA mixte, eval=FALSE, include=TRUE}

SLA_model <-lm(formula = data_standar$SLA ~ diameter + diameter:lBAL + lBAL + wetness + diameter:wetness  , data = data_standar[,5:10])
step(SLA_model, direction = "both")

```


```{r echo=TRUE}
SLA_model <- lm(formula = data_standar$SLA ~ diameter + lBAL + wetness + diameter:wetness,data = data_standar[, 5:10])
summary(SLA_model)
```


```{r echo=FALSE}
par(mfrow = c(2,2))
plot(SLA_model)
```
  
Linear Models: the absolute value of the t--statistic for each model parameter is used.
```{r message=FALSE, warning=FALSE, include=FALSE}
library(caret)

Imp_SLA<- varImp(SLA_model, nonpara = FALSE)

Imp_SLA <- Imp_SLA %>%  mutate(Variables = row.names(Imp_SLA), Trait = rep("SLA", nrow(Imp_SLA))) %>% 
  rename(Importance = Overall)
```

  
#### adding soil data

```{r  eval=FALSE, include=TRUE}
envi_soil <- envi_soil %>%  filter(!is.na(Dawkins))

SLA_soil <- lm(formula = envi_soil$SLA ~ diameter + diameter:lBAL + lBAL + wetness +Carbon + Phosphorus, data = envi_soil[,1:8])

step(SLA_soil , direction = "both")
```


```{r include=FALSE}
SLA_soil <-lm(formula = envi_soil$SLA ~ diameter + lBAL + wetness + diameter:lBAL,data = envi_soil[, 1:8])

```

```{r include=FALSE}
Imp_SLA_soil<- varImp(SLA_soil, nonpara = FALSE)

Imp_SLA_soil<- Imp_SLA_soil%>%  mutate(Variables = row.names(Imp_SLA_soil), Trait = rep("SLA", nrow(Imp_SLA_soil))) %>% 
  rename(Importance = Overall)
```


###  LDMC model
#### general environment

```{r LDMC model 1, eval=FALSE, include=TRUE}
LDMC_model <- lm(data_standar$LDMC~ diameter + diameter:lBAL + lBAL + wetness+ diameter:wetness, data = data_standar[,5:10])

step(LDMC_model, direction = "both")
```

```{r LDMC model 2, echo=FALSE}

LDMC_model <- lm(formula = data_standar$LDMC ~ diameter + lBAL + wetness + 
    diameter:lBAL, data = data_standar[, 5:10])

summary(LDMC_model)
```
 
```{r echo=FALSE}
par(mfrow = c(2,2))
plot(LDMC_model)
```

```{r include=FALSE}
Imp_LDMC<- varImp(LDMC_model, nonpara = FALSE)

Imp_LDMC <- Imp_LDMC %>%  mutate(Variables = row.names(Imp_LDMC), Trait = rep("LDMC", nrow(Imp_LDMC))) %>% 
  rename(Importance = Overall)
```

#### adding soil data


```{r  eval=FALSE, include=TRUE}
LDMC_soil <- lm(formula = envi_soil$LDMC ~  diameter + diameter:lBAL + lBAL + wetness +Carbon + Phosphorus , data = envi_soil[,1:8])

step(LDMC_soil , direction = "both")
```

```{r ,include=FALSE}
LDMC_soil <- lm(formula = envi_soil$LDMC ~ diameter + lBAL + wetness + diameter:lBAL, 
    data = envi_soil[, 1:8])
```


```{r include=FALSE}
Imp_LDMC_soil<- varImp(LDMC_soil, nonpara = FALSE)

Imp_LDMC_soil<- Imp_LDMC_soil%>%  mutate(Variables = row.names(Imp_LDMC_soil), Trait = rep("LDMC", nrow(Imp_LDMC_soil))) %>% 
  rename(Importance = Overall)
```

### LT model 
#### general environment


```{r eval=FALSE, include=TRUE}
LT_model <- lm(data_standar$LT~ diameter + diameter:lBAL + lBAL + wetness +diameter:wetness , data = data_standar)

step(LT_model, direction = "both")
```


```{r echo=FALSE}
LT_model <- lm(formula = data_standar$LT ~ diameter + diameter:lBAL + lBAL + 
    wetness + diameter:wetness, data = data_standar)

summary(LT_model)
```

```{r echo=FALSE}
par(mfrow = c(2,2))
plot(LT_model)
```


```{r}
Imp_LT<- varImp(LT_model, nonpara = FALSE)

Imp_LT <- Imp_LT %>%  mutate(Variables = row.names(Imp_LT), Trait = rep("LT", nrow(Imp_LT))) %>% 
  rename(Importance = Overall)
```

#### adding soil data 

```{r eval=FALSE, include=TRUE}

LT_soil <- lm(formula = envi_soil$LT ~diameter + diameter:lBAL + lBAL + wetness + Carbon+ Phosphorus  , data = envi_soil[,1:8])

step(LT_soil,  direction = "both")
        
```

```{r echo=FALSE}
LT_soil <- lm(formula = envi_soil$LT ~ diameter + Carbon, data = envi_soil[, 
    1:8]) 
summary(LT_soil)
```


```{r include=FALSE}
Imp_LT_soil<- varImp(LT_soil, nonpara = FALSE)

Imp_LT_soil<- Imp_LT_soil%>%  mutate(Variables = row.names(Imp_LT_soil), Trait = rep("LT", nrow(Imp_LT_soil))) %>% 
  rename(Importance = Overall)
```

### stable LT data


```{r include=FALSE}
LT_decrease <- c("3","7","2","16","8","9","10","11","12","6") 
data_LT <- data_standar %>% mutate(n_parcelle = as.factor(n_parcelle)) %>%  filter (!n_parcelle %in% LT_decrease )

soil_LT <- envi_soil %>%  filter( n_parcelle != "6" & n_parcelle != "11")
```


```{r eval=FALSE, include=FALSE}
LT_model2 <- lm(LT~ diameter + diameter:lBAL + lBAL + wetness +diameter:wetness+jour , data = data_LT)

step(LT_model2, direction = "both")
```

```{r echo=FALSE}
LT_model2 <- lm(formula = LT ~ diameter + wetness + diameter:wetness, data = data_LT)
summary(LT_model2)
```

#### soil_LT 

```{r eval=FALSE, include=FALSE}
LT_soil2 <- lm(LT~ diameter + diameter:lBAL + lBAL + wetness +diameter:wetness+jour+Carbon + Phosphorus , data = soil_LT)

step(LT_soil2, direction = "both")
```

```{r echo=FALSE}
LT_soil2 <- lm(formula = LT ~ diameter, data = soil_LT)
summary(LT_model2)
```


### sample day 
 

```{r eval=FALSE, include=FALSE}
LT_model3 <- lm(LT~ diameter + diameter:lBAL + lBAL + wetness +diameter:wetness+ jour , data = data_standar)

step(LT_model3, direction = "both")
```

```{r}
LT_model3 <- lm(formula = LT ~ diameter + wetness + jour + diameter:wetness, 
    data = data_standar)
summary(LT_model3)
```

#### soil day 


```{r eval=FALSE, include=TRUE}

LT_soil <- lm(formula = envi_soil$LT ~diameter + diameter:lBAL + lBAL + wetness + Carbon+ Phosphorus +jour , data = envi_soil)

step(LT_soil,  direction = "both")
        
```

```{r echo=FALSE}
LT_soil <- lm(formula = envi_soil$LT ~ diameter + lBAL + jour + diameter:lBAL, data = envi_soil)
summary(LT_soil)
```


### Cc model 
#### general environment 


```{r eval=FALSE, include=TRUE}
Cc_model <- lm(data_standar$Cc~diameter + diameter:lBAL + lBAL + wetness + diameter:wetness , data = data_standar[,5:10])

step(Cc_model, direction = "both")
```

```{r echo=FALSE}
Cc_model <- lm(formula = data_standar$Cc ~ diameter + lBAL + wetness, data = data_standar[, 
    5:10])

summary(Cc_model)
```


```{r echo=FALSE}
par(mfrow = c(2,2))
plot(Cc_model)
```

```{r}
Imp_Cc<- varImp(Cc_model, nonpara = FALSE)

Imp_Cc <- Imp_Cc %>%  mutate(Variables = row.names(Imp_Cc), Trait = rep("Cc", nrow(Imp_Cc))) %>% 
  rename(Importance = Overall)
```

#### adding soil data 

```{r eval=FALSE, include=TRUE}
Cc_soil <- lm(formula = envi_soil$Cc ~diameter + diameter:lBAL + lBAL + wetness +Carbon + Phosphorus, data = envi_soil[,1:8])

step(Cc_soil,  direction = "both")
        
```

```{r echo=FALSE}
Cc_soil <- lm(formula = envi_soil$Cc ~ diameter + lBAL + wetness, data = envi_soil[, 
    1:8])
summary(Cc_soil)
```


```{r include=FALSE}
Imp_Cc_soil<- varImp(Cc_soil, nonpara = FALSE)

Imp_Cc_soil<- Imp_Cc_soil%>%  mutate(Variables = row.names(Imp_Cc_soil), Trait = rep("Cc", nrow(Imp_Cc_soil))) %>% 
  rename(Importance = Overall)
```

### LA model 
#### general environment


```{r eval=FALSE, include=TRUE}
LA_model <- lm(data_standar$LA~ diameter + diameter:lBAL + lBAL + wetness + diameter:wetness , data = data_standar)

step(LA_model, direction = "both")
```

```{r echo=FALSE}
LA_model <-lm(formula = data_standar$LA ~ diameter + lBAL + wetness, data = data_standar[, 
    5:10])

summary(LA_model)
```


```{r echo=FALSE}
par(mfrow = c(2,2))
plot(LA_model)
```

```{r}
Imp_LA<- varImp(LA_model, nonpara = FALSE)

Imp_LA <- Imp_LA %>%  mutate(Variables = row.names(Imp_LA), Trait = rep("LA", nrow(Imp_LA))) %>% 
  rename(Importance = Overall)
```


#### adding soil data 

```{r eval=FALSE, include=TRUE}
LA_soil <- lm(formula = envi_soil$LA ~ diameter + diameter:lBAL + lBAL + wetness +Carbon+Phosphorus, data = envi_soil[,1:8])

step(LA_soil,  direction = "both")
        
```

```{r include=FALSE}
LA_soil <-lm(formula = envi_soil$LA ~ diameter + lBAL + wetness + diameter:lBAL, 
    data = envi_soil[, 1:8])
```


```{r include=FALSE}
Imp_LA_soil<- varImp(LA_soil, nonpara = FALSE)

Imp_LA_soil<- Imp_LA_soil%>%  mutate(Variables = row.names(Imp_LA_soil), Trait = rep("LA", nrow(Imp_LA_soil))) %>% 
  rename(Importance = Overall)
```


### BT model 
#### general environment

```{r eval=FALSE, include=TRUE}

BT_model <- lm(formula= data_standar$BT~ diameter + diameter:lBAL + lBAL + wetness +  diameter:wetness , data = data_standar[,5:10])
step(BT_model, direction = "both")
```

```{r echo=FALSE}
BT_model <- lm(formula = data_standar$BT ~ diameter, data = data_standar[,5:10])

summary(BT_model)
```

```{r echo=FALSE}
par(mfrow = c(2,2))
plot(BT_model)
```

```{r include=FALSE}
Imp_BT<- varImp(BT_model, nonpara = FALSE)

Imp_BT <- Imp_BT %>%  mutate(Variables = row.names(Imp_BT), Trait = rep("BT", nrow(Imp_BT))) %>% 
  rename(Importance = Overall)
```


#### adding soil data 

```{r eval=FALSE, include=TRUE}
BT_soil <- lm(formula = envi_soil$BT ~diameter + diameter:lBAL + lBAL + wetness + Carbon + Phosphorus, data = envi_soil[,1:8])

step(BT_soil,  direction = "both")
```

```{r echo=FALSE}
BT_soil <- lm(formula = envi_soil$BT ~ diameter + lBAL + wetness + Carbon, 
    data = envi_soil[, 1:8]) 
summary(BT_soil)
```

```{r echo=FALSE}
par(mfrow = c(2,2))
plot(BT_soil)
```

Individual number 103 is really close to the Cook distance line 

And scale location should be linear.


```{r include=FALSE}
Imp_BT_soil<- varImp(BT_soil, nonpara = FALSE)

Imp_BT_soil<- Imp_BT_soil%>%  mutate(Variables = row.names(Imp_BT_soil), Trait = rep("BT", nrow(Imp_BT_soil))) %>% 
  rename(Importance = Overall)
```

### BD model 
#### general environment

```{r eval=FALSE, include=TRUE}

BD_model <- lm(formula= data_standar$BD~ diameter + diameter:lBAL + lBAL + wetness +  diameter:wetness , data = data_standar[,5:10])
step(BD_model, direction = "both")
```

```{r echo=FALSE}
BD_model <- lm(formula = data_standar$BD ~ diameter + wetness, data = data_standar[, 
    5:10])

summary(BD_model)
```

```{r echo=FALSE}
par(mfrow = c(2,2))
plot(BD_model)
```


```{r include=FALSE}
Imp_BD<- varImp(BD_model, nonpara = FALSE)

Imp_BD <- Imp_BD %>%  mutate(Variables = row.names(Imp_BD), Trait = rep("BD", nrow(Imp_BD))) %>% 
  rename(Importance = Overall)
```

#### adding soil data

```{r eval=FALSE, include=TRUE}
BD_soil <- lm(formula = envi_soil$BD ~ diameter + diameter:lBAL + lBAL + wetness +Carbon+Phosphorus, data = envi_soil[,1:8])

step(BD_soil,  direction = "both")
```

```{r echo=FALSE}
BD_soil <-lm(formula = envi_soil$BD ~ diameter + lBAL + wetness + Carbon, 
    data = envi_soil[, 1:8]) 
summary(BD_soil)
```


```{r echo=FALSE}
par(mfrow = c(2,2))
plot(BD_soil)
```
Individual n°42 is over the Cook's distance line


```{r include=FALSE}
Imp_BD_soil<- varImp(BD_soil, nonpara = FALSE)

Imp_BD_soil<- Imp_BD_soil%>%  mutate(Variables = row.names(Imp_BD_soil), Trait = rep("BD", nrow(Imp_BD_soil))) %>% 
  rename(Importance = Overall)
```


### WD model 
#### general environment

```{r eval=FALSE, include=TRUE}

WD_model <- lm(formula= data_standar$WD~diameter + diameter:lBAL + lBAL + wetness  + diameter:wetness , data = data_standar[,5:10])
step(WD_model, direction = "both")
```

```{r echo=FALSE}
WD_model <- lm(formula = data_standar$WD ~ diameter, data = data_standar[, 
    5:10])

summary(WD_model)
```

```{r echo=FALSE}
par(mfrow = c(2,2))
plot(WD_model)
```


```{r include=FALSE}
Imp_WD<- varImp(WD_model, nonpara = FALSE)

Imp_WD <- Imp_WD %>%  mutate(Variables = row.names(Imp_WD), Trait = rep("WD", nrow(Imp_WD))) %>% 
  rename(Importance = Overall)
```


#### adding soil data 


```{r eval=FALSE, include=TRUE}
WD_soil <- lm(formula = envi_soil$WD ~diameter + diameter:lBAL + lBAL + wetness +Carbon +Phosphorus, data = envi_soil[,1:8])

step(WD_soil,  direction = "both")
```

```{r echo=FALSE}
WD_soil <- lm(formula = envi_soil$WD ~ diameter + Phosphorus, data = envi_soil[, 
    1:8])
summary(WD_soil)
```


```{r echo=FALSE}
par(mfrow = c(2,2))
plot(WD_soil)
```


```{r include=FALSE}
Imp_WD_soil<- varImp(WD_soil, nonpara = FALSE)

Imp_WD_soil<- Imp_WD_soil%>%  mutate(Variables = row.names(Imp_WD_soil), Trait = rep("WD", nrow(Imp_WD_soil))) %>% 
  rename(Importance = Overall)
```



## How environmental factor influence the distribution of trait ? 
Explicative variable coefficient (Beta) sign table with significative codes of F-statistic. Coefficient signs are from additive or multiplicative linear model fitted by step procedure with AIC criterion for each studed trait.

### Row data set (additive)

Summary table for additive model fitted for eall functionnal trait with different sample headcount (401 ; 169 ; 50) 
```{r echo=FALSE}
model_tab = matrix(NA, ncol = 9, nrow = 9)
model_tab <- as.data.frame(model_tab)

names(model_tab)<- c("Variables","Specific Leaf Area", "Leaf Dry Matter Content", "Leaf Thickness", "Leaf Area","Chlorophyll content", "Branch Bark Thickness" , "Branch Bark density" , "Branch Wood density ")

model_tab$Variables<- c("Intercept","Diameter"," lBAL  ","Diameter:lBAL", "Wetness", "Diameter:wetness", "Carbon", "Phosphorus", "Adjusted R²")

model_tab$`Specific Leaf Area`<- c("[-]","[-]***", "[+]", NA,"[+]*", "[+]*",NA,NA,"0.2515")

model_tab$`Leaf Dry Matter Content`<-  c("[-]", "[+]***","[+]",NA,"[-]***","[+]*",NA,NA,"0.2218")

model_tab$`Leaf Thickness`<- c("[+]","[+]***","[-]**", "[-].", "[+]**","[-].", "[-]*",NA,"0.2679") 

model_tab$`Chlorophyll content`<- c("[+]","[+]***","[+].",NA,"[-]***",NA,NA,NA,"0.1033")

model_tab$`Leaf Area` <- c("[-]", "[-]***","[-]**", NA, "[+]***", NA, NA, NA,"0.2898")

model_tab$`Branch Bark Thickness`<- c("[+]", "[+]***", NA, NA, NA, NA ,"[+]**", NA,"0.2329")

model_tab$`Branch Bark density` <- c("[+]", "[-]", NA, NA, "[-]***", NA,"[+]",NA ,"0.3753")

model_tab$`Branch Wood density ` <- c("[-]", "[+]**",NA,NA,NA,NA,NA, "[-]*", "0.1434")




for(i in 2:ncol(model_tab)){
  for(j in 1:nrow(model_tab)){
    # could be written if(!is.na) in other cases
    if(!is.na(model_tab[j,i])){
      model_tab[j,i] <- cell_spec(model_tab[j,i], "html", color = ifelse(grepl("[+]",model_tab[j,i]),"green", "red"))
    }
    else{
      # We have to write the "NA" in the same syntax, else kable doesnt understand why you use a syntax in some cells and not in others
      model_tab[j,i] <- paste0('<span style=" color: black;" >',model_tab[j,i],"</span>")
      # commande de tunage de couleur :<span style=" color: red;" >[ - ].</span>
    }
  }           
}


kable(model_tab,"html", escape = F) %>%  kable_styling(bootstrap_options = c("striped", "hover", "condensed","background-color :white")) %>%  add_footnote(c("NA's are non selected variables by step method","Wood trait models(BT, BD and WD) are fitted with 50 individuals","Models with Carbon and Phosphorus variables are fitted with 170 individuals", "Coefficient F -statistic ; Signif. codes:  0 '***' , 0.001 '**', 0.01 '*' ,0.05 '.', 0.1 ' ' "), notation = "alphabet") %>%  add_header_above(c(" " = 1, "Acquisition trait" = 5, "Structure trait" = 3))


```


```{r include=FALSE}
rm("model_tab")
```

### Stable LT data
Summary table for additive model fitted for eall functionnal trait with a sub-sample  from plot number 14-15-13-1-5-4, wich correspond to November sample month when leaf thickness measure is stable over sampling time.
Soil data cover plot number 1-6-11-13-14-15, two of them correspond to hightly decreasing leaf thickness measures (6 and 11) so they have been removed. 

```{r echo=FALSE}
model_tab = matrix(NA, ncol = 3, nrow = 10)
model_tab <- as.data.frame(model_tab)

names(model_tab)<- c("Variables","LT_total", "LT_stable")

model_tab$Variables<- c("Intercept","Diameter"," lBAL  ","Diameter:lBAL", "Wetness", "Diameter:wetness", "Carbon", "Phosphorus","jour" ,"Adjusted R²")

model_tab$LT_total <- c("[+]***", "[+]***",NA,NA, "[+]**","[-]*", NA,NA,"[-]***","0.5066") 

model_tab$`LT_stable`<- c("[+]***","[+]***",NA, NA, "[+]","[-]*", NA,NA,NA,"0.2763") 

for(i in 2:ncol(model_tab)){
  for(j in 1:nrow(model_tab)){
    # could be written if(!is.na) in other cases
    if(!is.na(model_tab[j,i])){
      model_tab[j,i] <- cell_spec(model_tab[j,i], "html", color = ifelse(grepl("[+]",model_tab[j,i]),"green", "red"))
    }
    else{
      # We have to write the "NA" in the same syntax, else kable doesnt understand why you use a syntax in some cells and not in others
      model_tab[j,i] <- paste0('<span style=" color: black;" >',model_tab[j,i],"</span>")
      # commande de tunage de couleur :<span style=" color: red;" >[ - ].</span>
    }
  }           
}


kable(model_tab,"html", escape = F) %>%  kable_styling(bootstrap_options = c("striped", "hover", "condensed","background-color :white")) %>%  add_footnote(c("NA's are non selected variables by step method","Models with Carbon and Phosphorus variables are fitted with 126 individuals", "Coefficient F -statistic ; Signif. codes:  0 '***' , 0.001 '**', 0.01 '*' ,0.05 '.', 0.1 ' ' "), notation = "alphabet") 


```


```{r include=FALSE}
rm("model_tab")
```

### Raw data set (multiplicative)
Summary table for mutiplicative model fitted for all functionnal trait.


```{r echo=FALSE}
model_tab = matrix(NA, ncol = 9, nrow = 7)
model_tab <- as.data.frame(model_tab)

names(model_tab)<- c("Variables","Specific Leaf Area", "Leaf Dry Matter Content", "Leaf Thickness", "Leaf Area","Chlorophyll content", "Branch Bark Thickness" , "Branch Bark density" , "Branch Wood density ")

model_tab$Variables<- c("Intercept","Diameter"," lBAL  ", "Wetness", "Carbon", "Phosphorus", "Adjusted R²")

model_tab$`Specific Leaf Area`<- c("[+]***","[-]***", "[+]*",NA, NA,NA,"0.2811")

model_tab$`Leaf Dry Matter Content`<-  c("[-]***", "[+]***","[+]","[-]***",NA,NA,"0.2556")

model_tab$`Leaf Thickness`<- c("[+]***","[+]***","[-]**",  "[+]**", "[-]*",NA,"0.2368") 

model_tab$`Chlorophyll content`<- c("[+]***","[+]***","[+]","[-]***",NA,NA,"0.1367")

model_tab$`Leaf Area` <- c("[+]***", "[-]***","[-]***", "[+]***",  NA, NA,"0.3142")

model_tab$`Branch Bark Thickness`<- c("[-]***", "[+]***", NA, "[+]","[+]***", NA,"0.3007")

model_tab$`Branch Bark density` <- c("[-]***",  NA, NA, "[-]***", NA,NA ,"0.3246")

model_tab$`Branch Wood density ` <- c("[-]", "[-].","[+]","[-]",NA, "[-]*", "0.1299")


for(i in 2:ncol(model_tab)){
  for(j in 1:nrow(model_tab)){
    # could be written if(!is.na) in other cases
    if(!is.na(model_tab[j,i])| is.numeric(model_tab[j,i])){
      model_tab[j,i] <- cell_spec(model_tab[j,i], "html", color = ifelse(grepl("[+]",model_tab[j,i]),"green", "red"))
    }
    else{
      # We have to write the "NA" in the same syntax, else kable doesnt understand why you use a syntax in some cells and not in others
      model_tab[j,i] <- paste0('<span style=" color: black;" >',model_tab[j,i],"</span>")
      # commande de tunage de couleur :<span style=" color: red;" >[ - ].</span>
    }
  }           
}


kable(model_tab,"html", escape = F) %>%  kable_styling(bootstrap_options = c("striped", "hover", "condensed","background-color :white")) %>%  add_footnote(c("NA's are non selected variables by step method","Wood trait models(BT, BD and WD) are fitted with 50 individuals","Models with Carbon and Phosphorus variables are fitted with 169 individuals", "Coefficient F -statistic ; Signif. codes:  0 '***' , 0.001 '**', 0.01 '*' ,0.05 '.', 0.1 ' ' "), notation = "alphabet") %>%  add_header_above(c(" " = 1, "Acquisition trait" = 5, "Structure trait" = 3))


```




## Which variable is the most influent ?

```{r include=FALSE}
rm("SLA_model", "LT_model", "BD_model", "LA_model", "LDMC_model","BT_model", "WD_model", "Cc_model")

rm("SLA_soil", "LT_soil", "BD_soil", "LA_soil", "LDMC_soil","BT_soil", "WD_soil", "Cc_soil")
```


The relative importance of each model variables is calculted with the unction "varimp" from caret package. A S3 method for linear model uses the absolute value of the t-statistic for each model parameter as proxy of importance. All measures of importance are scaled to have a maximum value of 100.


```{r include=FALSE}
Imp_data <- rbind(Imp_SLA, Imp_LT, Imp_BD, Imp_LA, Imp_LDMC,Imp_BT, Imp_WD, Imp_Cc)

Imp_data_soil <- rbind(Imp_SLA_soil, Imp_LT_soil, Imp_BD_soil, Imp_LA_soil, Imp_LDMC_soil,Imp_BT_soil, Imp_WD_soil, Imp_Cc_soil)

rm("Imp_SLA", "Imp_LT", "Imp_BD", "Imp_LA", "Imp_LDMC","Imp_BT", "Imp_WD", "Imp_Cc")

rm("Imp_SLA_soil", "Imp_LT_soil", "Imp_BD_soil", "Imp_LA_soil", "Imp_LDMC_soil","Imp_BT_soil", "Imp_WD_soil", "Imp_Cc_soil")
```


```{r echo=FALSE}


Imp_data  %>% mutate(Importance = as.integer(Importance)) %>% 
 ggplot(aes(x = Trait, y = Importance, fill = Variables))+
  geom_bar(stat = "identity")+
  #labs(title = "Variance component analysis", y = "fraction of the total variance explained
       #by each scale (value*100) ", x= "functional trait")+
  scale_fill_brewer(palette="Set3")+
  geom_text(aes(label = Importance, group = Variables),position = position_stack(vjust = 0.5))+
  ggtitle("Variable relative importance of each trait model 
          (non comparable data) ")

```

```{r echo=FALSE}
Imp_data_soil  %>% mutate(Importance = as.integer(Importance)) %>% 
 ggplot(aes(x = Trait, y = Importance, fill = Variables))+
  geom_bar(stat = "identity")+
  #labs(title = "Variance component analysis", y = "fraction of the total variance explained
       #by each scale (value*100) ", x= "functional trait")+
  scale_fill_brewer(palette="Set3")+
  geom_text(aes(label = Importance, group = Variables),position = position_stack(vjust = 0.5))+
  ggtitle("Variable relative importance of each trait soil model 
          (non comparable data) ")
```

# Is there a functional difference between morphotypes ?


```{r trait standar2, include=FALSE}
trait_standar <- environment_trait %>%
  dplyr::select(LT, Cc, LDMC, SLA, LA,morphotype_field) %>% mutate(morphotype_field= as.character(morphotype_field)) 

trait_standar[,1:5] <- as.data.frame(scale(as.matrix(trait_standar[,1:5]), center = TRUE, scale = TRUE))
```
  
```{r echo=FALSE, message=FALSE, warning=FALSE}
trait_pca <- PCA(trait_standar, quali.sup = 6, graph = F)

fviz_pca_biplot(trait_pca , axes = c(1, 2), label ="var", habillage = 6,  col.var = "black")# habillage only works without col.var = "contrib"

```

Globulifera and Sp.1 morphotype 




## In our case of woody tropical perenial species which of LDMC or LT contribute the most to SLA ?
As N. Pérez-Harguindeguy et al. (2013) SLA is a function of LDMC and LT and both component can contribute to SLA to different degrees, depending on the habitat and plant group in question.

```{r echo=FALSE, message=FALSE, warning=FALSE}
trait_pca <- PCA(trait_standar[, c("SLA", "LT", "LDMC", "morphotype_field")], quali.sup = 4, graph = F)

fviz_pca_biplot(trait_pca , axes = c(1, 2), label ="var", habillage = 4,  col.var = "black")
```



# Functional diversity at the intra-specific scale

From Cianciaruso et al (2016) : Calculating individual Functional Diversity (iFD) involves four steps (Petchey and Gaston 2002, 2006): (1) assembling a trait matrix (species in rows and functional traits in columns), (2) converting the trait matrix into a distance matrix, (3) producing a dendrogram by clustering the distance matrix, and (4) calculating the total branch length of the dendrogram necessary to connect all species in the community. We used Euclidean distance and the unweighted pair group method with arithmetic averages (UPGMA) to produce, respectively, the distance matrix and the dendrogram (Podani and Schmera 2006, Petchey and Gaston 2007).
